
**内容大纲：**
1.  **`switch-to-domain` 执行失败**
    * 原因分析：DNS 解析未生效；80 端口被其他程序占用。
    * 解决方案：指导用户使用 `ping` 或 `dig` 检查解析，并使用 `ss -tlnp | grep :80` 检查端口占用。
2.  **为什么域名模式下 Trojan 协议无法连接？**
    * **（此处直接并入您现有的 `02-Trojan连接问题排查.md` 的优秀内容）**
3.  **证书自动续期失败怎么办？**
    * 指导用户手动执行 `edgeboxctl cert renew` 并查看 Certbot 的输出日志来定位问题。

# **【EdgeBox 问题排查】为什么域名模式下 Trojan 协议无法连接？**

## **问题现象**

在使用 `edgeboxctl switch-to-domain <你的域名>` 命令切换到域名模式后，你可能会发现 VLESS (Reality/gRPC/WS) 等协议均可正常使用，唯独 Trojan 协议连接超时或失败（在客户端中延迟显示为 `-1`）。

## **问题根源**

这是正常现象，并非脚本 Bug，其根本原因在于 **Trojan 协议的伪装设计** 和 **TLS 证书的安全机制**。

1.  **Trojan 的特殊伪装**：为了达到更好的隐蔽效果，EdgeBox 中的 Trojan 协议被设计为通过一个专有的子域名（例如 `trojan.your.domain.com`）进行访问。这使得它的流量特征与访问主域名（`your.domain.com`）的 gRPC/WS 流量完全区分开，增强了安全性。

2.  **TLS 证书验证**：当你为 `your.domain.com` 申请证书时，Let's Encrypt 只确认了你对这个主域名的所有权。因此，颁发的证书只对 `your.domain.com` 有效。当 Trojan 客户端按照配置，带着 `trojan.your.domain.com` 的“门牌号”（即 SNI）来访问服务器时，后端的 Xray 服务会检查这个“门牌号”是否在证书的有效名单上。由于证书上没有这个子域名，Xray 会认为这是一个不安全的、潜在的假冒连接，并为了安全而拒绝握手，导致连接失败。

简单来说：**客户端敲的是 `trojan` 的门，但服务器的证书上只写了主人的名字，没有写 `trojan` 这个别名，于是服务器就不给开门。**

## **解决方案：添加 A 记录并更新证书**

解决办法非常简单，就是为 `trojan` 这个子域名添加一条指向您服务器 IP 的 DNS A 记录，然后让脚本更新证书，把这个“别名”也加到证书里。

### **第一步：在您的 DNS 服务商处添加 A 记录**

1.  登录您的域名注册商或 DNS 服务提供商（如 Cloudflare, GoDaddy, NameSilo 等）。

2.  找到 `dataline66.dpdns.org` 这个域名的 DNS 解析管理页面。

3.  点击 **“添加记录”**（Add Record），然后填写以下信息：

      * **类型 (Type)**: `A`
      * **名称 (Name / 主机记录 / Host)**: `trojan`
      * **内容 (Content / 记录值 / Points to)**: `35.000.197.61` (您的服务器 IP 地址)
      * **TTL**: 选择“自动”或保持默认值即可。

添加完成后，您的解析列表应该类似下面这样，**包含两条 A 记录**：

| 类型 | 名称 (Name) | 内容 (IP Address) |
|:----|:----------------------------|:------------------|
| A | dataline66.dpdns.org | 35.000.197.61 |
| A | **trojan**.dataline33.dpdns.org | 35.00.197.61 |

### **第二步：等待 DNS 解析生效**

通常只需要几分钟。您可以在服务器上执行 `ping trojan.dataline66.dpdns.org` 命令，如果它能正确显示您的服务器 IP，则说明解析已生效。

### **第三步：在服务器上更新证书**

当 DNS 解析生效后，回到 SSH 终端，**重新运行**您之前执行过的 `switch-to-domain` 命令：

```bash
edgeboxctl switch-to-domain dataline66.dpdns.org
```

这次，脚本中的 `certbot` 程序会检测到 `trojan.dataline33.dpdns.org` 已经正确解析，它会自动**扩展 (Expand)** 您现有的证书，将这个子域名也添加进去。

##### **第四步：测试连接**

命令成功执行后，证书即已更新。此时，您无需更换客户端的订阅链接，只需在客户端中对 Trojan 节点重新进行延迟测试，它就应该可以正常连接了。
