# **问题排查：域名与证书**

本指南解决在配置和使用域名模式及 Let's Encrypt 证书时遇到的所有常见问题。

### **1. `edgeboxctl switch-to-domain <域名>` 执行失败**

  * **问题现象**：切换到域名模式的命令执行失败，终端报错。
  * **常见原因及解决方案**：
      * **错误提示 `Domain does not resolve to this server` (域名未解析到本机)**
          * **原因**: 您的 DNS 解析尚未生效，或者解析到了错误的 IP 地址。
          * **解决**:
            1.  请耐心等待几分钟，DNS 全球生效需要时间。
            2.  在服务器上执行 `ping <您的域名>`，确认返回的 IP 是您当前服务器的公网 IP。
      * **错误提示 `Certbot failed with error code X` (Certbot 申请失败)**
          * **原因**: Let's Encrypt 的验证服务器无法通过 `80` 端口访问您的服务器。最常见的原因是**云服务商安全组未放行 TCP 80 端口**，或是服务器上已有其他程序（如 Apache）占用了 `80` 端口。
          * **解决**:
            1.  登录云服务商控制台，检查并确保 TCP `80` 端口已对公网开放。
            2.  在服务器上运行 `ss -tlnp | grep :80`，检查是否有其他程序正在监听 `80` 端口。如果有，请先停止它。
            3.  问题解决后，重新运行 `switch-to-domain` 命令。

### **2. 域名模式下 Trojan 协议无法连接**

  * **问题现象**：切换到域名模式后，其他协议正常，唯独 Trojan 协议连接超时。
  * **原因分析**：这是设计的正常行为。为了增强隐蔽性，EdgeBox 的 Trojan 协议被配置为通过一个专属子域名 `trojan.<您的域名>` 进行访问。而您首次申请证书时，只为 `  <您的域名> ` 主域名申请了证书。当客户端使用 `trojan.<您的域名>` 作为 SNI 连接时，服务器证书验证会失败，从而拒绝连接。
  * **解决方案**：您需要为 `trojan.<您的域名>` 添加 DNS 解析，并让脚本更新证书以包含这个子域名。
    1.  **添加 DNS A 记录**：登录您的 DNS 服务商，为 `trojan` 这个主机记录添加一条 A 记录，指向您的服务器 IP。
    2.  **等待解析生效**：在服务器上 `ping trojan.<您的域名>`，确认解析正确。
    3.  **更新证书**：**重新运行**一次 `edgeboxctl switch-to-domain <您的域名>` 命令。Certbot 会自动检测到新的子域名并**扩展 (Expand)** 您现有的证书，将其包含进去。
    4.  命令成功后，无需任何其他操作，Trojan 即可正常连接。

### **3. 证书自动续期失败**

  * **问题现象**：收到了 Let's Encrypt 关于证书即将过期的邮件通知。
  * **原因分析**：Certbot 的自动续期任务未能成功执行。最常见的原因与申请时类似：**80 端口的访问路径被阻断**。
  * **解决方案**：
    1.  **手动续期并观察日志**：在服务器上执行 `edgeboxctl cert renew`。这个命令会直接显示 Certbot 的续期过程和详细日志。
    2.  **分析错误**：根据日志输出定位问题。绝大多数问题依然是由于 80 端口无法被 Let's Encrypt 访问导致。请确保云服务商安全组和服务器内部防火墙始终对公网开放 TCP `80` 端口。
    3.  **修复并重试**：解决端口问题后，再次执行 `edgeboxctl cert renew` 直到成功。

### **4. 手动替换证书后无法工作**

  * **问题现象**：您手动将自己的其他证书文件替换了 `/etc/edgebox/cert/` 目录下的文件，但服务无法启动。
  * **原因分析**：文件权限不正确，导致 Nginx、Xray 等服务没有权限读取私钥。
  * **解决方案**：运行一键修复权限命令。
    ```bash
    edgeboxctl fix-permissions
    ```
    此命令会自动将证书目录和文件的所有者、权限设置为 EdgeBox 要求的标准状态，然后重启服务即可。

-----
