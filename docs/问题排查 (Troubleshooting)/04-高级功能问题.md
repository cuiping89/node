# **问题排查：高级功能**

本指南用于解决在使用出站分流、流量预警等高级功能时可能遇到的问题。

### **1. 出站分流 (Shunt) 配置后似乎未生效**

  * **问题现象**：执行 `edgeboxctl shunt resi` 或 `direct-resi` 命令后，访问网站显示的 IP 仍然是服务器的 IP。
  * **排查步骤**：
    1.  **确认当前模式**：运行 `edgeboxctl shunt status`，检查“当前模式”是否确实为您设置的代理或分流模式。
    2.  **检查代理健康状态**：在 `edgeboxctl shunt status` 的输出中，查看“上游代理健康状态”。如果显示为 `unhealthy` 或连接失败，说明您的代理信息配置有误或代理服务本身已失效。请检查您提供的代理 URL 是否正确。
    3.  **理解分流范围**：请记住，出站分流策略**仅对 Xray 协议生效**（VLESS 系列, Trojan）。Hysteria2 和 TUIC 协议为了性能考虑，**始终通过 VPS 直接连接**，这是设计的预期行为。请确认您测试时使用的客户端协议是 VLESS 或 Trojan。
    4.  **检查 Xray 日志**：如果以上都正常，运行 `edgeboxctl logs xray` 并尝试访问网站。如果 Xray 连接上游代理失败，日志中会打印出详细的错误信息。

### **2. 白名单修改后未立即生效**

  * **问题现象**：使用 `edgeboxctl shunt whitelist add/remove` 修改了白名单，但在 `direct-resi` 模式下，流量走向没有变化。
  * **原因分析**：修改白名单仅仅是更新了域名列表文件。为了让 Xray 加载这个新的规则集，需要重新生成并应用 Xray 的配置文件。
  * **解决方案**：在每次修改完白名单后，**必须重新执行一次 `direct-resi` 命令**来应用更改。
    ```bash
    # 在添加/删除/重置白名单后，必须执行此命令以应用
    edgeboxctl shunt direct-resi '<您的代理URL>'
    ```

### **3. 流量预警测试收不到通知**

  * **问题现象**：执行 `edgeboxctl alert test` 命令后，配置的 Telegram, Discord 或微信渠道没有收到任何消息。
  * **排查步骤**：
    1.  **检查配置信息**：运行 `edgeboxctl alert show`，仔细核对您的 **Bot Token**, **Chat ID**, **Webhook URL** 是否完全正确，没有遗漏或多余的字符。
    2.  **检查服务器网络**：确认您的服务器可以访问通知服务商的 API。
          * **Telegram**: 在服务器上运行 `curl https://api.telegram.org`。如果长时间无响应或报错，说明您的服务器网络无法连接到 Telegram。
          * **Discord / PushPlus**: 运行 `curl <您的Webhook URL>`。如果报错，请检查 URL 是否正确。
    3.  **查看预警日志**：这是最有效的排错方式。运行以下命令查看详细日志：
        ```bash
        tail -n 20 /var/log/edgebox-traffic-alert.log
        ```
        日志中会记录 `curl` 命令的详细输出，通常会直接指出失败的原因（如 `401 Unauthorized`, `404 Not Found` 等）。
    4.  **Telegram 特殊检查**：
          * **您对您创建的机器人说过 `/start` 吗？** 这是最常见的问题。必须先与您的机器人开始对话，它才能向您发送消息。
          * **Chat ID 是否正确？** 如果是发送到群组，Chat ID 通常是负数，请确保没有遗漏负号。
