
# **通用排查指南与诊断流程**

遇到连接问题时，请不要慌张。EdgeBox 内置了一套强大的自我诊断工具，遵循本指南的流程，您将能自行解决 90% 以上的常见问题。

## **第一步：排障黄金三命令**

这三个命令是您定位问题的“瑞士军刀”，请务必掌握。

| 命令 | 用途 |
| :--- | :--- |
| `edgeboxctl status` | **全局健康检查**。这是排障的**第一步**。它会清晰地显示核心服务（Nginx, Xray, sing-box）是否在运行，以及所有公网端口的监听状态。 |
| `edgeboxctl debug-ports` | **深度端口诊断**。当 `status` 命令显示服务正常但连接依然失败时，此命令能帮您检查所有内部和外部端口的监听细节，快速定位端口冲突或服务假死问题。 |
| `edgeboxctl logs <service>` | **查看实时日志**。这是定位深层错误的**终极手段**。通过查看 `nginx`, `xray`, `sing-box` 的实时日志，您可以直接看到具体的错误信息。 |

-----

## **第二步：标准诊断流程**

请严格按照以下顺序进行排查，这能最高效地定位问题。

### **1. 检查云服务商安全组/防火墙**

> **这是最常见、最高频的问题来源，占比超过 90%！**

无论您使用哪家云服务商（AWS, GCP, Azure, Oracle, Vultr 等），都请登录其管理控制台，检查实例的**安全组 (Security Group)**、**网络ACL (NACL)** 或**防火墙 (Firewall)** 规则，确保以下端口已对公网 (`0.0.0.0/0`) 开放：

  * **TCP**: `80`, `443`
  * **UDP**: `443`, `2053`

> **注意**：这是在**云平台层面**的设置，与服务器内部的防火墙（UFW/firewalld）无关。即使服务器内部防火墙已放行，如果云安全组未配置，流量依然会被阻断。

### **2. 运行 `edgeboxctl status` 检查服务**

在 SSH 终端执行 `edgeboxctl status`。

  * **如果显示任一服务 `inactive (dead)` 或 `failed` (红色)**：
      * **原因**：服务未能成功启动。
      * **解决**：立即使用 `edgeboxctl logs <服务名>` 查看失败原因。例如，若 `xray` 启动失败，则运行 `edgeboxctl logs xray`，日志末尾通常会直接指出错误（如配置文件语法错误、证书路径问题等）。
  * **如果所有服务均为 `active (running)` (绿色)**：
      * **原因**：服务本身已正常运行，问题可能出在端口监听或外部网络。
      * **解决**：进入下一步。

### **3. 运行 `edgeboxctl debug-ports` 检查端口**

执行 `edgeboxctl debug-ports`。

  * **如果任一关键公网端口（如 `443/tcp`, `443/udp`）未被监听**：
      * **原因**：服务虽然运行，但未能成功绑定到端口。
      * **解决**：这通常意味着配置文件存在逻辑问题。请检查相关服务的日志（`edgeboxctl logs <service>`）以获取线索。
  * **如果所有端口都正常监听**：
      * **原因**：服务器内部一切正常。问题几乎可以确定是**服务器与客户端之间的网络路径**存在问题。
      * **解决**：返回第一步，再次仔细检查云服务商安全组。如果确认无误，请检查您本地网络的防火墙或代理设置。

-----

## **常见问题快速索引 (FAQ)**

  * **Q: 安装后所有协议都无法连接，客户端延迟显示 -1ms 或超时？**

      * A: **99% 的可能性是您云服务商的安全组没有放行端口**。请返回本指南的**第一步**，仔细检查并确保 TCP `443` 和 UDP `443`, `2053` 端口已对公网开放。

  * **Q: 控制面板 (网页) 无法访问？**

      * A: 首先运行 `edgeboxctl status` 检查 `nginx` 服务是否为 `active (running)`。如果不是，运行 `edgeboxctl logs nginx` 查看错误日志。如果 Nginx 正常，请检查云服务商安全组是否放行了 TCP `80` 和 `443` 端口。

  * **Q: 只有 UDP 协议 (Hysteria2 / TUIC) 无法使用？**

      * A: 这几乎总是因为 UDP 端口被阻断。请检查**云服务商安全组**是否放行了 UDP `443` 和 `2053` 端口。

-----

这份文档专门解决用户在安装和更新过程中可能遇到的问题。

