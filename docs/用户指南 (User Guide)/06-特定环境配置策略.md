
# **特定环境配置策略**

尽管 EdgeBox 的一键安装脚本设计为在大多数主流 Linux 环境中通用，但在特定的云服务商（如 GCP, AWS）或网络环境（如使用 Cloudflare）下，通过一些针对性的配置，可以进一步优化性能、有效控制成本，并避免一些常见的“陷阱”。

本指南旨在为您提供在不同平台上部署和运维 EdgeBox 的最佳实践。

-----

## **1. GCP (Google Cloud Platform) 环境**

GCP 以其优质的网络著称，但也因其出站流量费用较高而需要特别注意。

  * **核心策略**：**严防流量回源，避免不必要的出站成本。**

  * **预算与告警设置**
    强烈建议在 GCP 控制台的 **“结算 (Billing) -\> 预算和提醒 (Budgets & alerts)”** 中为您项目设置一个月度预算告警。同时，可以在 **“监控 (Monitoring) -\> 提醒 (Alerting)”** 中，利用 `network/sent_bytes_count` 指标创建滚动时间窗口的阈值告警（例如，24小时内流量超过 10 GiB），以及时发现异常流量。

  * **DNS 强制直连**
    为避免 DNS 解析本身产生不必要的代理流量费用，EdgeBox 在 `sing-box` 配置中已将 DNS 查询明确指向 `direct`（直连），并通过路由规则强制所有 `UDP/53` 的流量直接从服务器出口发出。

-----

## **2. AWS (Amazon Web Services) 环境**

  * **核心策略**：**充分利用每月免费的出站流量额度。**

  * **善用智能分流**
    AWS 的 EC2 实例通常每月提供一定额度的免费出站流量（例如 100GB）。您可以通过 `direct-resi` 智能分流模式，将大流量的视频、下载等业务放在白名单内，使其通过 VPS 直连消耗免费额度。而将需要维持账号画像的小流量业务（如登录、支付）通过代理出口，实现成本效益最大化。

    ```bash
    # 切换到智能分流模式，让白名单内的域名走VPS直连，其余走代理
    edgeboxctl shunt direct-resi '<您的代理URL>'
    ```

  * **设置预算告警**
    请务-必在 AWS 管理控制台开启 **AWS Budgets** 服务，设置一个略低于您预期的成本阈值，以便在免费额度即将用尽或产生预期外费用时，第一时间收到邮件通知。

-----

## **3. 使用 Cloudflare 解析域名**

这是一个非常普遍的场景，但错误的配置会导致性能下降和潜在的计费问题。

  * **核心策略**：**确保流量直达服务器，避免 Cloudflare 代理回源。**

  * **必须使用 DNS Only (灰云)**
    如果您使用 Cloudflare 解析域名，务必将指向您服务器 IP 的 A/AAAA 记录的“代理状态”设置为 **DNS Only (仅DNS，灰云)**，而不是 Proxied (已代理，橙云)。否则，所有流量都会先经过 Cloudflare 再到达您的服务器，这会导致延迟增加，并可能隐藏客户端的真实 IP。

  * **严禁开启 Cloudflare 流量服务**
    **切勿**在 Cloudflare 上为您的域名开启 Argo、WARP 或 Zero Trust 等任何流量代理服务。这些服务会将您服务器的**出站流量**也牵引至 Cloudflare 的网络，这在 GCP、AWS 等计算出站流量的平台上会被计算为高额的流量费用。

-----

## **4. 其他 VPS/VM 通用策略**

对于其他有明确流量限制的云服务商（如阿里云、Vultr、Bandwagon 等）。

  * **核心策略**：**精细化监控，避免流量超额。**

  * **定期检查用量**
    养成定期使用 `edgeboxctl traffic show` 命令或访问 Web 控制面板查看流量统计的习惯，并与您服务商后台的用量数据进行交叉比对。

  * **使用流量预警功能**
    这是 EdgeBox 为您提供的最强大的成本控制工具。请务必根据您套餐的流量上限，配置好月度预算和通知渠道。

    ```bash
    # 示例：如果您的套餐每月提供 1TB (约 1000 GiB) 流量
    edgeboxctl alert monthly 1000

    # 在用量达到 50%、80%、95% 时收到通知
    edgeboxctl alert steps 50,80,95

    # 配置您的 Telegram 机器人
    edgeboxctl alert telegram <您的Token> <您的Chat ID>
    ```

  * **警惕“隐式代理”**
    部分服务商可能会提供一些“智能加速”、“网络优化”等增值服务。请谨慎开启，并确认其工作原理，避免它们在您不知情的情况下将服务器流量重定向，从而产生额外费用或导致 IP画像混乱。

-----

## **5. 快速自检清单**

在配置完成后，您可以通过以下命令快速验证各项策略是否按预期工作。

  * **验证出站 IP**：

    ```bash
    # 在 vps 模式下，应返回您的服务器公网 IP
    # 在 resi 模式下，或在 direct-resi 模式下访问非白名单网站时，应返回代理的出口 IP
    curl -s https://ipinfo.io/ip
    ```

  * **验证 Cloudflare 是否为灰云模式**：

    ```bash
    # 将 yourdomain.com 替换为您的域名
    # 命令应返回您的服务器真实 IP
    dig A yourdomain.com +short

    # 返回的 HTTP 头中不应出现 server: cloudflare 或 cf-ray
    curl -I https://yourdomain.com
    ```

  * **验证 `nftables` 计数器** (用于智能分流流量统计)：

    ```bash
    # 检查 resi_addr set 是否已被正确写入代理IP地址
    nft list sets inet edgebox
    ```

  * **验证分流效果**：
    在 `direct-resi` 模式下，访问一个白名单内的网站（如 YouTube），然后查看控制面板的流量图表。一段时间后，您应该能观察到 **VPS 出口（蓝色）** 的流量有明显增长，而 **代理出口（绿色）** 流量增长平缓。
