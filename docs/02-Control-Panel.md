# EdgeBox 控制面板 (Control Panel)

EdgeBox 控制面板是项目的核心图形用户界面（GUI），旨在提供一个轻量、高效、直观的中心化视图，用于监控服务器状态、查阅配置详情、获取订阅链接以及掌握流量使用情况。

该面板是一个纯静态的 HTML 页面 (`index.html`)，通过异步请求后端生成的 JSON 文件来动态填充数据，实现了前后端的完全分离。

## 页面布局与核心组件

控制面板采用现代化的**卡片式布局 (Card-based UI)**，将各项功能和信息逻辑地划分到不同的卡片中，确保信息层次清晰，一目了然。

![控制面板截图](image_38b61c.png)

| 卡片区域 | 主要内容 | 数据来源 |
| :--- | :--- | :--- |
| **顶部信息区** | 服务器负载、核心服务状态、证书信息、版本号等。 | 动态生成 |
| **协议与分流** | 所有已部署协议的配置详情、当前出站分流模式与状态。 | 动态生成 |
| **订阅链接** | 明文、Base64、B64逐行三种格式的订阅链接及复制按钮。 | 动态生成 |
| **流量统计** | 近30日流量趋势图、本月用量进度条、近12个月累计流量图。 | 动态生成 |
| **运维管理** | `edgeboxctl` 核心管理命令的快速参考。 | 静态内容 |

### 1. 顶部信息区
此区域让用户可以快速概览服务器的整体健康状况。
* **服务器负载与网络身份**：实时显示 CPU 和内存的使用率进度条，以及服务器的 IP 地址和关联域名。
* **核心服务**：以状态徽章（`运行中`/`已停止`）的形式展示 Nginx、Xray 和 Sing-box 三大核心服务的当前状态。
* **证书信息**：显示当前的网络模式（IP/域名）、证书类型（自签名/Let's Encrypt）、到期日期和续期方式。

### 2. 协议配置与出站分流状态
这个并排的卡片区域是面板的核心交互区之一。
* **协议配置 (左侧)**：以表格形式列出所有已启用的协议（如 VLESS-Reality, Trojan, Hysteria2 等）。每一行都包含了协议名称、网络类型、伪装效果、适用场景和运行状态，并提供一个“详情”链接，点击后可查看该协议的详细客户端配置参数（如 UUID、密码等）。
* **出站分流状态 (右侧)**：
    * **模式切换标签**：高亮显示当前的出站模式（VPS-IP出站 / 代理IP出站 / 分流模式）。
    * **状态信息**：显示 VPS 出站 IP、代理配置状态以及 VPS 白名单的域名概览。

### 3. 订阅链接
提供三种格式的订阅链接，以适应不同客户端的需求，并配有一键复制功能。
* **明文链接**：人类可读的原始链接。
* **B64逐行**：将每个协议链接单独进行 Base64 编码，每行一个。
* **Base64**：将所有协议链接合并后进行 Base64 编码，生成单一的订阅字符串。

### 4. 核心功能：流量统计 (Traffic Statistics)
流量统计是控制面板的核心功能之一，它提供了一个可视化的流量监控系统，让您能够清晰地掌握出站流量的去向。它在网卡总流量的基础上，精确区分出“VPS 直连”与“住宅代理”的流量，为您提供最具决策价值的数据。

#### 设计理念
* **聚焦出站去向**：统计的核心指标是“VPS 出口”与“住宅出口”，而非简单的网卡总流量。
* **轻量化架构**：采用 `vnStat` + `nftables` 进行后端数据采集，并通过 `JSON` 结构化存储。前端 `Chart.js` 在浏览器本地渲染图表，保持服务器端极度轻量。
* **双时间维度**：
    * **近30日出站流量** (曲线图)：直观展示短期内的流量波动和分流效果。
    * **近12个月累计流量** (柱状图)：帮助掌握长期的流量规模和成本趋势。
    * **本月累计/阈值** (进度条)：在标题栏实时显示当月已用流量占预算的百分比。

#### 工作流程
1.  **后端采集 (`traffic-collector.sh`)**：
    * 由 `cron` 每小时自动触发。
    * 通过 `vnStat` 获取网卡的总出站流量。
    * 通过 `nftables` 计数器精确统计流向住宅代理的流量。
    * 计算得出 **“VPS 出口流量” = “总出站流量” - “住宅出口流量”**。
    * 将聚合数据写入 `daily.csv` 和 `monthly.csv`，并最终生成前端所需的 `traffic.json`。
2.  **前端渲染 (`index.html`)**：
    * 页面加载时，异步请求 `traffic.json` 文件。
    * 使用 Chart.js 将 `last30d` 数据渲染成双曲线趋势图。
    * 将 `monthly` 数据渲染成多堆栈柱状图。
    * 根据当月最新数据和预警配置 (`alert.conf`) 计算百分比，并更新进度条。

## 技术实现：数据流与口径
为了确保控制面板能够稳定、统一地展示服务器的各类状态，系统采用了一套清晰的、单向的数据流机制。理解这个机制是进行问题排查和功能扩展的关键。

整个过程可以概括为：**后端脚本定时采集 -> 生成统一JSON文件 -> 前端异步请求并渲染**。

#### **第一步：数据源 (Sources of Truth)**
所有前端展示的数据，其最原始的来源是服务器上的配置文件或系统命令。主要包括：

* **核心配置**：`/etc/edgebox/config/server.json` (包含UUID、密码、IP等)。
* **出站分流白名单**：`/etc/edgebox/config/shunt/whitelist.txt` (纯文本，每行一个域名)。
* **分流模式状态**：`/etc/edgebox/config/shunt/state.json` (记录当前是VPS模式还是代理模式)。
* **系统实时状态**：通过 `/proc/stat`, `/proc/meminfo` 等系统文件获取 CPU 和内存使用率。
* **服务运行状态**：通过 `systemctl is-active <service>` 命令获取 Nginx, Xray, Sing-box 的状态。

#### **第二步：后端聚合脚本 (The Backend Aggregator)**
这是整个数据流的核心枢纽。系统中**唯一**负责为前端生成数据的脚本是：

* **脚本位置**：`/etc/edgebox/scripts/dashboard-backend.sh`

该脚本的主要职责是：采集所有原始数据，处理成规范的 JSON 格式，并聚合成一个单一、完整的 JSON 对象。

#### **第三步：中心化数据接口 (The Centralized Data "API")**
后端脚本的**唯一输出**是一个静态的 JSON 文件。这个文件扮演了前端与后端之间数据交换的“API接口”角色。

* **接口文件**：`/etc/edgebox/traffic/dashboard.json`
* **流量文件**：`/etc/edgebox/traffic/traffic.json`
* **系统文件**：`/etc/edgebox/traffic/system.json`

这些文件包含了前端页面所需的所有动态信息。其结构经过精心设计，例如，白名单数据在 `dashboard.json` 中对应的路径是 `shunt.whitelist`。

#### **第四步：定时刷新机制 (Automation via Cron)**
为了让前端数据能够“准实时”更新，系统通过 `cron` 定时任务来周期性地执行聚合脚本。

* **定时任务**：`/etc/edgebox/scripts/dashboard-backend.sh` 脚本被设置为**每2分钟**执行一次，以更新 `dashboard.json` 和 `system.json`。
* **工作流程**：每隔2分钟，`cron` 触发脚本 -> 脚本重新采集所有最新数据 -> 覆盖写入对应的 JSON 文件。

#### **第五步：前端消费与渲染 (Frontend Consumption)**
前端 `index.html` 页面完全不关心后端的复杂逻辑。它只做一件事：

1.  **异步请求**：页面加载后，其内置的 JavaScript 会使用 `fetch` 函数，向 `/traffic/` 目录下的三个 JSON 文件发起 HTTP GET 请求。
2.  **数据驱动渲染**：获取到 JSON 数据后，JavaScript 会解析这些 JSON 对象，并将其中的值（如 `server.ip`, `services.nginx`, `shunt.whitelist` 等）填充到页面上对应的 HTML 元素中。

## 相关文件结构
```
/etc/edgebox/
  ├─ traffic/                      # Nginx Web 根目录，也是前端资源的存放地
  │   ├─ logs/
  │   │   ├─ daily.csv             # 日粒度流量记录
  │   │   └─ monthly.csv           # 月粒度流量记录
  │   ├─ dashboard.json          # 【核心】控制面板主数据文件
  │   ├─ traffic.json            # 【核心】流量统计数据文件
  │   ├─ system.json             # 【核心】系统负载数据文件
  │   ├─ alert.conf              # 预警配置文件
  │   └─ index.html              # 控制面板的入口HTML文件
  │
  └─ scripts/
      ├─ dashboard-backend.sh      # 【核心】后端数据聚合脚本 (cron定时执行)
      └─ traffic-collector.sh      # 后端流量采集脚本 (cron定时执行)
```
