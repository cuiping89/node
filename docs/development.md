-----

## **📚 开发者指南**

  * **项目结构**：项目遵循模块化设计，包括 `ENV/install.sh`、`scripts/`、`configs/` 和 `edgeboxctl` 等目录，职责清晰。
  * **内核契约**：明确定义了端口契约、Nginx 回落机制、证书软链接、基础订阅契约，以及安装/卸载与测试用例。

-----
### **分模块开发**

该项目的设计理念是将复杂的部署和运维过程分解为三个独立的模块，每个模块都基于前一个模块定义的**“内核契约”**进行开发。这种分层架构确保了项目的可维护性、稳定性和可扩展性。

---

### 模块 1 - 核心基础安装（内核契约）

**目标**：提供一个功能完整、稳定可靠的基础安装包。该模块负责所有核心服务的部署，并定义后续模块将依赖的**“内核契约”**。

**协议配置与契约定义**
* **端口契约**：公网 **443/TCP 端口**由 **Nginx 监听**，作为所有 TCP 协议的唯一入口。Xray 的 Reality、VLESS-gRPC 和 VLESS-WS 服务均监听**内部回环端口**，不直接暴露在公网。
* **分流机制**：**Nginx** 负责唯一的流量分发。它使用 `stream` 模块的 `ssl_preread` 功能，根据流量的 **SNI** 和 **ALPN**，直接将流量转发到 Xray 对应的内部回环端口。本方案不依赖 Xray 的任何回落（fallbacks）功能。
* **证书软链接**：确保所有服务（Nginx, Xray, sing-box）都从 `/etc/ssl/certs/` 下的统一路径读取证书。
* **基础订阅**：确保 `install.sh` 在安装完成后能生成一个基础的、硬编码的订阅链接。订阅链接的格式、字段是模块 2 动态生成订阅的契约。

**测试与验证**
* **功能测试**：在干净的虚拟机上运行 `install.sh`，验证所有服务是否正常运行、端口是否正确监听，以及客户端是否能成功连接所有 5 个协议。
* **幂等卸载测试**：运行 `uninstall.sh` 并验证所有文件和服务是否被完全清除。

---

### 模块 2 - `edgeboxctl` 管理工具

**前置条件**：模块 1 已完成并冻结“内核契约”。模块 2 的开发必须基于这些已定义的端口、文件路径和订阅格式。
**目标**：开发一个命令行工具，作为用户与核心服务进行交互的管理层，实现动态配置和模式切换。

**关键任务与交付物**
* **命令行工具 (`edgeboxctl`)**：使用 Shell 脚本（或 Python/Go）开发。
* **模式切换**：实现 `edgeboxctl` 的模式切换命令，用于在 IP 模式和域名模式之间双向切换。
* **证书管理**：`edgeboxctl cert renew` 和 `edgeboxctl cert upload`。
* **配置管理**：`edgeboxctl config regenerate-uuid` 和 `edgeboxctl config show`。
* **动态订阅生成**：`edgeboxctl sub` 命令应根据当前模式（IP/域名）和配置，动态生成并显示订阅链接。

---

### 模块 3 - 高级运维功能

**前置条件**：模块 1 和模块 2 已完成并冻结“内核契约”。
**目标**：在核心服务之上，集成额外的运维功能，如流量统计、备份恢复和流量预警，以提升项目的可用性和可维护性。

**关键任务与交付物**
* **流量统计**
    * **数据采集**：开发 `traffic-collector.sh` 脚本，利用 `vnStat` 和 `nftables` 定时采集流量数据。
    * **结构化存储**：将采集到的数据以 CSV 格式（`daily.csv` 和 `monthly.csv`）和 JSON 格式（`traffic-all.json`）进行存储。
    * **前端渲染**：设计一个包含订阅和流量总览的 `index.html` 页面，使用 `Chart.js` 读取 `traffic-all.json` 并动态绘制流量曲线和表格。
* **流量预警**
    * **配置文件**：创建 `alert.conf`，用于配置每月总流量预算和通知方式。
    * **预警脚本**：开发 `traffic-alert.sh` 脚本，定期运行并从 `monthly.csv` 中读取数据，根据预设的百分比阈值（30%、60%、90%）发送邮件或 Webhook 告警。
* **备份与恢复**
    * **自动备份**：创建 `cron` 任务，每日自动打包关键配置文件并生成备份文件。
    * **一键恢复**：实现 `edgeboxctl backup` 命令，支持列出备份、手动创建和恢复指定备份的功能。
* **NFTables 规则**：编写用于计数的 `nftables` 规则集，并确保 `edgeboxctl shunt` 命令在切换出站模式时能同步更新这些规则。



---

## 分模块维护：

**模块1：脚本头部+基础函数** (约800行)
- shebang、全局变量、颜色定义
- 日志函数、工具函数
- 系统检查、依赖安装

**模块2：系统信息收集+凭据生成** (约600行) 
- collect_system_info函数
- generate_credentials函数
- save_config_info函数

**模块3：服务安装配置** (约800行)
- 安装Xray、sing-box
- 配置Nginx、Xray、sing-box
- 生成订阅链接

**模块4：dashboard后端脚本生成** (约800行)
- create_dashboard_backend函数（完整的dashboard-backend.sh脚本）

**模块5：流量监控+运维工具** (约600行)
- setup_traffic_monitoring函数
- create_enhanced_edgeboxctl函数
- 其他辅助工具

**模块6：数据生成+主函数** (约400行)
- finalize_data_generation函数
- show_installation_info函数  
- main函数

这样分割的好处：
1. 每个模块功能独立，逻辑清晰
2. 你可以逐个检查每个模块
3. 出错时容易定位问题
4. 方便后续维护


