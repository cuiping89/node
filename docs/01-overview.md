
# 模块化架构-分模块维护

1. 每个模块功能独立，逻辑清晰
2. 你可以逐个检查每个模块
3. 出错时容易定位问题
4. 方便后续维护

-------

**模块1：脚本头部+基础函数** (约800行)
- shebang、全局变量、颜色定义
- 日志函数、工具函数
- 系统检查、依赖安装

这个模块包含了：
- ✅ 自动提权机制
- ✅ 全局变量和配置
- ✅ 完整的日志系统
- ✅ 系统兼容性检查
- ✅ 依赖包安装
- ✅ 目录结构创建
- ✅ 端口检查
- ✅ 防火墙配置
- ✅ 系统优化
- ✅ 错误处理机制

**使用说明：**
1. 这个模块是完整独立的，可以直接运行测试基础功能
2. 所有函数都有详细注释，方便后续维护
3. 错误处理完善，出问题会自动清理
4. 兼容Ubuntu/Debian/CentOS/RHEL等主流系统


-------


**模块2：系统信息收集+凭据生成**
- collect_system_info函数
- generate_credentials函数
- save_config_info函数

### ✅ **系统信息收集**
- 自动检测云厂商（AWS、GCP、Azure、Vultr、DO、Linode等）
- 收集CPU、内存、磁盘详细规格
- 获取实例ID、区域等云环境信息

### ✅ **协议凭据生成**
- 为每种协议生成独立UUID（VLESS-Reality、gRPC、WS、TUIC、Trojan）
- 生成强密码（Base64编码，32字节）
- 支持故障重新生成机制

### ✅ **Reality密钥对生成**
- 使用sing-box生成标准密钥对
- 生成8位短ID
- 支持延迟生成（模块3中重新生成）

### ✅ **配置文件生成**
- 生成完整的server.json，**完全对齐控制面板数据口径**
- 包含所有面板需要的字段（云厂商、硬件规格、凭据等）
- JSON格式验证和权限设置

### ✅ **自签名证书**
- 生成ECC证书（secp384r1曲线）
- 10年有效期
- 统一证书接口（current.pem/current.key）

### ✅ **数据完整性验证**
- 验证所有生成的数据
- 详细的错误检查和报告
- 故障恢复机制

**关键特性：**
- 完整的错误处理和日志记录
- 敏感信息保护（只显示前8位）
- 模块化设计，可独立调用
- 数据验证和故障恢复

-------


**模块3：服务安装配置** (约800行)
- 安装Xray、sing-box
- 配置Nginx、Xray、sing-box
- 生成订阅链接

**✓ 核心服务安装**
- Xray多协议代理服务安装
- sing-box现代协议服务安装
- 支持多架构自动检测下载

**✓ 高级网络架构配置**
- Nginx SNI定向 + ALPN兜底分流机制
- TCP/443端口统一入口，智能分发到各协议
- 内部回环端口隔离，提高安全性

**✓ 完整协议配置**
- VLESS-Reality（伪装真实网站）
- VLESS-gRPC（HTTP/2传输）
- VLESS-WebSocket（WebSocket传输）
- Trojan-TLS（伪装HTTPS流量）
- Hysteria2（UDP高性能协议）
- TUIC（现代UDP协议）

**✓ 订阅系统**
- 自动生成6种协议的订阅链接
- 支持IP模式和域名模式切换
- URL编码处理，确保特殊字符兼容

**✓ 服务管理**
- systemd服务配置和自启动
- 完整的端口监听验证
- 服务依赖关系处理


-------

**模块4：dashboard后端脚本生成 (约800行)**

create_dashboard_backend函数（完整的dashboard-backend.sh脚本）

**✓ Dashboard后端脚本 (dashboard-backend.sh)**
- 统一数据采集和聚合逻辑
- 安全的jq取值函数，避免空值错误
- 生成dashboard.json和system.json
- 完全对齐控制面板数据口径

**✓ 流量监控系统**
- nftables计数器配置（区分VPS和住宅出站）
- 流量采集脚本（每小时执行）
- CSV格式数据存储（daily.csv, monthly.csv）
- 自动生成traffic.json供前端使用

**✓ 流量预警系统**
- 多渠道通知支持（Telegram、Discord、微信PushPlus、Webhook）
- 可配置预警阈值（30%、60%、90%）
- 月度流量预算管理
- 去重预警机制

**✓ 定时任务管理**
- Dashboard数据刷新：每2分钟
- 流量数据采集：每小时
- 流量预警检查：每小时

**✓ 数据完整性保证**
- 原子文件替换，避免读取不完整数据
- 错误处理和日志记录
- 自动重试机制

-------

## 模块5：流量监控+运维工具功能概览

### 🔧 **核心功能组件**

#### 1. **流量监控系统 (`setup_traffic_monitoring`)**
- **nftables计数器**：自动创建用于流量分类统计的计数器
- **系统状态监控**：CPU/内存使用率实时监控
- **流量采集器**：每小时采集网卡流量，支持VPS/住宅代理分流统计
- **数据存储**：CSV格式存储（daily.csv, monthly.csv）+ JSON格式前端消费
- **预警系统**：支持多阈值流量预警和多种通知方式

#### 2. **增强版管理工具 (`create_enhanced_edgeboxctl`)**
完整的命令行管理工具，包含：

- **基础功能**：订阅查看、服务状态、日志查看、连接测试
- **证书管理**：Let's Encrypt申请/续期、IP/域名模式切换
- **出站分流**：VPS全量/住宅全量/智能分流三种模式
- **白名单管理**：添加/删除/列表/重置白名单域名
- **流量统计**：查看/重置流量数据
- **预警配置**：设置阈值、通知方式（Telegram/Discord/微信等）
- **备份恢复**：创建/列表/恢复系统备份
- **配置管理**：查看配置、重新生成UUID

#### 3. **IP质量评分系统 (`install_ipq_stack`)**
- **多源IP信息采集**：ipinfo.io、ip.sb、ip-api.com
- **质量评估**：DNSBL黑名单检查、延迟测试、ISP识别
- **智能评分**：基于多维度指标的自动评分（A-D等级）
- **实时监控**：监听分流状态变化自动重新评估
- **Web接口**：提供JSON格式的IP质量数据给前端

#### 4. **系统运维组件**
- **定时任务配置**：自动设置流量采集和预警的cron任务
- **邮件系统**：配置SMTP邮件发送功能
- **初始化服务**：开机自动启动流量监控服务

### 📊 **数据流架构**

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   网卡流量统计   │───▶│   CSV数据存储    │───▶│   JSON API输出   │
│  (vnStat+nft)  │    │ daily/monthly   │    │  (前端消费)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   系统资源监控   │    │   预警阈值检查   │    │   控制面板展示   │
│  (CPU/内存)    │    │  (多级通知)     │    │  (图表+统计)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 🎯 **重要特性**

1. **模块化设计**：每个功能组件独立，便于维护和扩展
2. **数据契约遵循**：严格按照技术规范文档的API设计
3. **错误处理完善**：包含详细的日志记录和错误恢复机制
4. **权限安全**：合理的文件权限设置和安全配置
5. **性能优化**：轻量级脚本设计，最小化系统资源占用

这个模块为EdgeBox系统提供了完整的运维管理能力，让用户可以通过简单的命令行工具管理复杂的网络代理系统，同时提供了专业级的流量监控和预警功能。

-------

## 模块6：数据生成+主函数功能概览

### 🎯 **核心功能组件**

#### 1. **数据同步与初始化 (`finalize_data_generation`)**
- **订阅文件同步**：统一管理订阅文件在多个位置的同步
- **分流配置初始化**：设置默认白名单和分流状态
- **面板数据生成**：首次生成dashboard.json和系统监控数据
- **权限设置**：确保Web服务器可以正确访问文件
- **系统验证**：验证关键文件、服务状态和端口监听

#### 2. **安装进度管理**
- **预安装检查**：磁盘空间、内存、端口冲突检测
- **进度条显示**：20步安装进程的可视化进度
- **错误处理**：完善的异常捕获和故障排除指南
- **用户交互**：关键决策点的用户确认机制

#### 3. **服务启动与验证 (`start_services`)**
- **服务管理**：系统化启动nginx、xray、sing-box
- **状态验证**：实时检查服务运行状态
- **依赖处理**：确保服务启动顺序和依赖关系
- **故障诊断**：服务启动失败时的日志输出

#### 4. **安装信息展示 (`show_installation_info`)**
- **配置摘要**：展示服务器信息、协议配置、访问地址
- **管理指南**：常用命令和高级功能说明
- **示例演示**：智能分流和流量预警的配置示例
- **状态报告**：当前服务运行状态的实时反馈

### 📊 **完整安装流程图**

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   预安装检查     │───▶│   基础环境配置   │───▶│   核心组件安装   │
│  (磁盘/内存/端口) │    │  (系统/网络/证书) │    │  (Xray/sing-box) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   高级功能安装   │    │   数据生成同步   │    │   服务启动验证   │
│ (监控/预警/管理) │    │ (订阅/面板/分流) │    │ (状态/性能/连接) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   最终验证      │    │   信息展示      │    │   完成安装      │
│ (文件/服务/端口) │    │ (配置/命令/状态) │    │ (成功/日志)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🏗️ **EdgeBox完整架构总览**

### **6个核心模块**

1. **模块1-基础安装**：系统检查、依赖安装、目录创建
2. **模块2-凭据生成**：UUID、密码、Reality密钥生成
3. **模块3-服务配置**：Nginx、Xray、sing-box配置
4. **模块4-后台脚本**：dashboard-backend数据聚合脚本
5. **模块5-运维工具**：流量监控、edgeboxctl管理工具、IP质量评分
6. **模块6-主程序**：数据初始化、服务启动、安装完成

### **核心特性一览**

#### 🔧 **技术架构**
- **SNI定向分流**：Nginx stream模块实现多协议复用443端口
- **证书管理**：IP/域名模式无缝切换，Let's Encrypt自动化
- **出站分流**：VPS直连/住宅代理/智能分流三种模式
- **流量统计**：nftables+vnStat实现精确的分流流量统计

#### 📊 **运维功能**
- **实时监控**：CPU/内存/磁盘/网络状态监控
- **流量预警**：多阈值告警，支持Telegram/Discord/微信推送
- **自动备份**：配置文件定期备份和一键恢复
- **IP质量评分**：多源IP信息聚合和智能评分

#### 🎛️ **管理界面**
- **Web控制面板**：流量图表、协议状态、系统信息一览
- **命令行工具**：edgeboxctl完整管理功能，涵盖证书、分流、监控、备份
- **订阅管理**：多格式订阅链接自动生成和同步
- **白名单管理**：域名级别的分流规则动态配置

#### 🚀 **协议支持**
- **VLESS-Reality**：最新的抗审查协议，伪装真实TLS流量
- **VLESS-gRPC/WS**：基于HTTP/2和WebSocket的传输
- **Trojan-TLS**：经典的TLS伪装协议
- **Hysteria2**：基于QUIC的高性能UDP协议
- **TUIC**：轻量级QUIC传输协议

### 🎯 **项目亮点**

#### 1. **企业级稳定性**
- 模块化设计，职责分离明确
- 完善的错误处理和日志记录
- 幂等性操作，支持重复安装
- 渐进式降级，关键功能独立运行

#### 2. **智能运维**
- 自适应流量分流策略
- 多维度IP质量评估
- 预测性流量预警
- 自动化证书管理

#### 3. **用户友好**
- 一键安装，零配置开箱即用
- 可视化进度显示
- 详细的帮助文档和示例
- 直观的Web管理界面

#### 4. **高度可扩展**
- 标准化API接口
- 插件化架构设计
- 统一的配置文件格式
- 开放的数据格式


-------

# 📁 **最终文件结构**

```
/etc/edgebox/
├── cert/                      # 证书文件
│   ├── current.key           # 当前使用的私钥（软链接）
│   ├── current.pem           # 当前使用的证书（软链接）
│   ├── self-signed.key       # 自签名私钥
│   └── self-signed.pem       # 自签名证书
├── config/                   # 配置文件
│   ├── server.json          # 服务器主配置
│   ├── xray.json            # Xray配置
│   ├── sing-box.json        # sing-box配置
│   ├── subscription.txt     # 订阅文件
│   ├── cert_mode            # 证书模式标识
│   └── shunt/               # 分流配置
│       ├── state.json       # 分流状态
│       ├── whitelist.txt    # 白名单域名
│       └── resi.conf        # 住宅代理配置
├── scripts/                 # 后台脚本
│   ├── dashboard-backend.sh # 面板数据聚合
│   ├── traffic-collector.sh # 流量采集
│   ├── traffic-alert.sh     # 流量预警
│   └── edgebox-init.sh      # 初始化脚本
└── traffic/                 # Web根目录
    ├── index.html           # 控制面板
    ├── dashboard.json       # 面板数据
    ├── traffic.json         # 流量数据
    ├── system.json          # 系统状态
    ├── alert.conf           # 预警配置
    ├── sub.txt              # 订阅缓存
    └── logs/                # 日志目录
        ├── daily.csv        # 日流量统计
        └── monthly.csv      # 月流量统计

/var/www/edgebox/status/     # IP质量数据
├── ipq_vps.json            # VPS IP质量
├── ipq_proxy.json          # 代理IP质量
└── ipq_meta.json           # 元数据

/usr/local/bin/
└── edgebox-ipq.sh          # IP质量评分脚本
└── edgeboxctl              # 管理工具

/var/www/html/
├── sub -> /etc/edgebox/config/subscription.txt  # 订阅链接
├── traffic -> /etc/edgebox/traffic               # 流量面板
└── status -> /var/www/edgebox/status             # 状态数据
```

### 🎊 **安装成功后的用户体验**

用户安装完成后将获得：

1. **即刻可用**：所有协议自动配置完成，订阅链接一键复制
2. **可视化管理**：Web界面查看流量、状态、配置信息
3. **智能预警**：流量超限自动通知，IP质量实时监控
4. **灵活分流**：支持VPS直连、代理分流、智能分流三种模式
5. **安全可靠**：自动备份、证书管理、服务监控
6. **易于维护**：一个命令完成所有管理操作

### 🔄 **持续演进**

EdgeBox的模块化架构为未来扩展提供了良好基础：

- **新协议支持**：可轻松添加新的代理协议
- **高级分流**：支持更复杂的路由规则
- **集群管理**：多节点统一管理界面
- **API接口**：提供RESTful API用于外部集成
- **插件系统**：用户自定义功能扩展

这个完整的EdgeBox系统代表了企业级代理服务器管理解决方案的最高标准，将复杂的网络技术封装为简单易用的管理界面，为用户提供专业级的网络服务体验。

