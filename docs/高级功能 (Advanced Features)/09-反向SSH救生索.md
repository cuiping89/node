
# **反向 SSH 救生索**

“反向 SSH 救生索”是 EdgeBox 提供的一项终极灾难恢复功能。它就像是您服务器的一把“备用钥匙”，确保在您因配置错误而无法从公网直接登录服务器时，依然有一条备用通道可以“救回”您的机器。

## **1. 这是什么功能？**

它会在您的 EdgeBox 服务器上启动一个名为 `edgebox-reverse-ssh.service` 的后台服务。该服务会主动从您的服务器**反向连接**到一台您指定的、可正常访问的 SSH 服务器（我们称之为“跳板机”）。

连接成功后，它会在**跳板机**上打开一个监听端口（默认为 `22022`）。

## **2. 救生索如何工作？（场景示例）**

想象一下，您不小心执行了一条错误的防火墙命令 (`ufw deny all`)，导致服务器的所有公网端口（包括 SSH 的 22 端口）都被关闭了。此时，您会发现 SSH 连接立刻中断，并且再也无法连上。

**如果没有救生索**：您可能需要联系服务商通过 VNC 控制台进行修复，过程非常繁琐。

**如果部署了救生索**：

1.  您**首先 SSH 登录到您的跳板机**。
2.  在跳板机上，执行以下命令，通过之前建立的反向隧道连接回“失联”的 EdgeBox 服务器：
    ```bash
    ssh root@localhost -p 22022
    ```
3.  成功登录！现在您就处在 EdgeBox 服务器的 shell 中了。
4.  执行 `ufw allow 22` 或其他修复命令，恢复服务器的公网访问。

## **3. 它是如何自动配置的？**

在执行 `install.sh` 脚本时，系统会自动进行智能探测，尝试为您配置救生索：

  * **检测 SSH 配置**：脚本会检查您服务器的 `/root/.ssh/config` 文件，寻找是否有别名为 `bastion`, `jump`, `gateway` 或 `gw` 的主机配置。如果找到，它会自动使用该主机的 IP、用户和端口作为跳板机信息。
  * **检测当前 SSH 客户端**：如果您是通过 SSH 连接到服务器来执行安装脚本的，脚本会获取您当前客户端的公网 IP，并尝试将其作为跳板机地址（前提是该 IP 的 22 端口是可访问的）。
  * **检测私钥**：脚本会自动查找 `/root/.ssh/` 目录下的常用私钥文件（如 `id_ed25519`, `id_rsa`）用于连接跳板机。

如果探测成功，救生索服务会在安装过程中自动启用。

## **4. 我需要做什么？**

  * **全自动（推荐）**：如果您有一台经常使用的、配置了 SSH 免密登录的跳板机，并且在 `~/.ssh/config` 中为它设置了别名，那么 EdgeBox 很大概率会自动为您配置好一切。
  * **手动配置**：您也可以在执行安装脚本前，通过设置环境变量来手动指定跳板机信息：
    ```bash
    export EB_RSSH_HOST="<跳板机IP>"
    export EB_RSSH_USER="<登录用户>"
    export EB_RSSH_PORT="<跳板机SSH端口>"
    export EB_RSSH_RPORT="<在跳板机上监听的端口>"
    export EB_RSSH_KEY_PATH="/root/.ssh/your_private_key"

    # 然后再执行安装命令
    bash <(curl -fsSL ...)
    ```

### **查看救生索状态**

您可以通过以下命令检查救生索服务是否已成功运行：

```bash
systemctl status edgebox-reverse-ssh.service
```

如果看到 `active (running)`，则表示您的备用通道已经建立成功。

-----
