# 流量预警与通知渠道配置

---

## 目录

* [概述](#概述)
* [工作原理与文件位置](#工作原理与文件位置)
* [快速入门（3 步）](#快速入门3-步)
* [命令参考](#命令参考)
* [渠道配置](#渠道配置)

  * [Telegram 机器人](#telegram-机器人)
  * [Discord Webhook](#discord-webhook)
  * [微信（PushPlus）](#微信pushplus)
  * [通用 Webhook（raw|slack|discord）](#通用-webhookrawslackdiscord)
  * [邮件（可选）](#邮件可选)
* [安全与权限](#安全与权限)
* [验证与排错](#验证与排错)
* [配置文件说明（示例）](#配置文件说明示例)
* [附：一键自检脚本](#附一键自检脚本)

---

## 概述

EdgeBox 提供基于 **月度流量预算** 的告警能力。系统按小时汇总当月出站用量，当达到设定阈值（如 50%/80%/95%）时，通过你配置的 **通知渠道**（Telegram / Discord / PushPlus / 通用 Webhook / 邮件）下发提醒，避免超量或被封顶。

---

## 命令参考

```text
edgeboxctl alert show                                 # 查看当前告警配置
edgeboxctl alert monthly <GiB>                        # 设置当月预算（单位 GiB）
edgeboxctl alert steps <p1,p2,...>                    # 设置分段阈值（百分比，逗号分隔）

edgeboxctl alert telegram <token> <chat_id>           # 配置 Telegram 渠道
edgeboxctl alert discord  <webhook_url>               # 配置 Discord 渠道（专用字段）
edgeboxctl alert wechat   <pushplus_token>            # 配置 PushPlus（微信）
edgeboxctl alert webhook  <url> [raw|slack|discord]   # 配置通用 Webhook（声明载荷格式）

edgeboxctl alert test [percent]                       # 模拟触发告警（默认 80%）
```
---

## 快速入门（3 步）

1. **设定预算与阈值**

```bash
edgeboxctl alert monthly 200        # 设置本月预算 200 GiB
edgeboxctl alert steps 50,80,95     # 在 50%、80%、95% 时各触发一次
```

2. **配置一个或多个通知渠道**（详见下文“渠道配置”）
3. **模拟触发，验证链路**

```bash
edgeboxctl alert test 80            # 模拟本月已用 80% 触发预警
edgeboxctl alert show               # 查看当前配置
sudo tail -n 20 /var/log/edgebox-traffic-alert.log
```

> 说明：`alert test` 不会消耗真实流量；它会临时构造一个 80% 用量场景，并重置 `alert.state` 以便观察告警是否能被触发。

---

## Telegram 渠道配置：

### **第 1 步：获取机器人 Token**

我们需要先在 Telegram 上创建一个机器人“小助手”来帮我们发消息。

1.  **找到“机器人教父”** 👑
    在 Telegram 搜索框中输入 **`@BotFather`**，选择那个有官方认证蓝色对勾 ✔️ 的账号，然后点击 **Start**。

2.  **创建新机器人**
    在对话框中输入 `/newbot` 并发送。

3.  **给机器人起名**
    BotFather 会问你机器人的名字，这个可以随便填，比如 `我的服务器管家`。

4.  **设置机器人用户名**
    接下来设置一个唯一的用户名，**规则是：必须以 `bot` 结尾**。例如 `MyVPS_alert_bot`。如果提示被占用，换一个即可。

5.  **复制 Token！** ✅
    成功后，BotFather 会发给你一大段包含 `Use this token to access the HTTP API:` 的消息。那串红色的、由数字和字母组成的长字符串就是您的 **Token**。

    > **请复制并保存好这串 Token，它像密码一样重要。**

6.  **(‼️ 关键一步) 启动你的机器人**
    点击 BotFather 消息中你刚刚创建的机器人链接（例如 `@MyVPS_alert_bot`），进入和它的对话框，然后**务必点击底部的 `Start` 按钮**。

### **第 2 步：获取你的 Chat ID**

`Chat ID` 就是告诉机器人“要把消息发给谁”的地址。

1.  **找到“ID查询机器人”** 🆔
    在 Telegram 搜索框中输入 **`@userinfobot`**，选择它并点击 **Start**。

2.  **获取你的 ID**
    它会立刻回复您的信息，其中 `Id:` 后面的那一串**纯数字**就是您的 **Chat ID**。

### **第 3 步：在服务器上配置并测试**

现在，我们回到服务器的SSH终端，把刚刚获得的两个“密码”告诉 EdgeBox。

1.  **执行配置命令**
    运行以下命令，将 `<您的Token>` 和 `<您的Chat ID>` 替换成您刚刚获得的内容：

    edgeboxctl alert telegram <您的Token> <您的Chat ID>

    **例如：**

    ```bash
    edgeboxctl alert telegram 123456:ABC-DEF_your_token 987654321
    ```

2. 执行测试命令： dgeboxctl alert test

3.  **检查 Telegram！** 🎉
    如果一切顺利，您的 Telegram 会立刻收到一条来自您机器人的测试消息，就像这样：

恭喜！您的流量预警通知已经配置成功。现在服务器会在流量达到阈值时自动通知您了。

### **收不到消息怎么办？**

如果执行 `edgeboxctl alert test`后没有收到消息，请按以下顺序检查：
1.  **您对创建的机器人说过 `/start` 吗？** 这是最常见的问题，请返回第1步的第6小步确认。
2.  **Token 和 Chat ID 复制正确了吗？** Token很长，Chat ID对于群组是负数。请仔细核对。
3.  **服务器能连接到 Telegram 吗？** 在服务器上运行 `curl https://api.telegram.org`，如果长时间没反应或报错，说明您的服务器网络访问 Telegram 受限。
   
---



### 微信（PushPlus）配置

**用途**：通过 PushPlus 触达微信，该功能通过第三方服务“PushPlus推送加”实现，配置过程简单，无需企业微信。

#### **第一步：获取您的 PushPlus Token**

1.  **关注公众号**：打开微信，搜索并关注公众号：`PushPlus推送加`。

2.  **登录并复制 Token**：在页面上找到名为 “**你的token**” 的信息，复制它后面那一长串由字母和数字组成的字符串。

#### **第二步：在服务器上配置 Token**

通过 SSH 工具登录到您的服务器终端。

2.  **执行配置命令**：运行以下命令，将 `<你的PushPlus Token>` 替换为您在上一步复制的真实 Token：edgeboxctl alert wechat <你的PushPlus Token>

3.  当屏幕显示 `[SUCCESS] 已设置 WeChat PushPlus` 时，表示配置已成功保存。

#### **第三步：发送测试通知（推荐）**

验证配置是否生效：edgeboxctl alert test

如果配置正确，您的微信会立刻收到一条来自“PushPlus推送加”的测试预警消息，配置完成！当您的服务器流量使用达到设定的阈值时，系统将自动向您的微信发送告警通知。

---


好的，没有问题。我已根据您提供的原始文档，结合项目文档的最佳实践，对其进行了全面优化。

优化后的版本结构更清晰、语言更精炼、排版更美观，并补充了关键提示，非常适合直接并入您的项目文档中。

-----

### **EdgeBox 流量预警与通知渠道配置指南**

#### **🎯 概述**

EdgeBox 提供了强大的月度流量预警功能。当服务器的出站流量达到您设定的预算百分比（如 50%, 80%）时，系统会自动通过您选择的渠道发送通知。这能有效帮助您管理成本，避免因流量超额导致服务中断或产生额外费用。

支持的通知渠道包括：

  * **Telegram** (推荐)
  * **Discord** (推荐)
  * **微信 (通过 PushPlus)**
  * 通用 Webhook
  * 邮件 (可选，配置稍复杂)

-----

#### **🚀 三步快速入门**

只需三步，即可开启您的流量告警。

1.  **设定预算与阈值**
    通过 `edgeboxctl` 命令设置您服务器的月度流量上限和提醒阶段。

    ```bash
    # 示例：设置本月总预算为 200 GiB
    edgeboxctl alert monthly 200

    # 示例：在用量达到 50%、80% 和 95% 时分别发送一次通知
    edgeboxctl alert steps 50,80,95
    ```

2.  **配置至少一个通知渠道**
    从下方选择一个您最方便的渠道，并按照其指南进行配置。我们推荐使用 **Telegram** 或 **微信**。

3.  **测试通知**
    执行测试命令，模拟一次 80% 的流量用量告警，以验证整个通知链路是否通畅。

    ```bash
    edgeboxctl alert test 80
    ```

    执行后，您配置的通知渠道应立即收到一条测试消息。如果没有，请参考文末的 [验证与排错](https://www.google.com/search?q=%23-%E9%AA%8C%E8%AF%81%E4%B8%8E%E6%8E%92%E9%94%99) 部分。

-----

#### **⚙️ 渠道配置详解**

##### **1. Telegram 机器人 (推荐)**

此方法将创建一个专属的 Telegram 机器人，用于向您发送告警。

1.  **与 `@BotFather` 对话**

      * 在 Telegram 中搜索 `@BotFather` (有官方认证 ✔️ 标志)，进入对话并点击 `/start`。
      * 发送 `/newbot` 命令以创建新机器人。
      * 根据提示，依次为您的机器人设置一个昵称（如 `我的服务器管家`）和唯一的用户名（必须以 `bot` 结尾，如 `MyEdgeBoxAlert_bot`）。
      * 创建成功后，BotFather 会返回一条消息，其中包含一串红色的 **Token**。**请务必复制并妥善保管它**。

2.  **启动机器人并获取 Chat ID**

      * 点击 BotFather 消息中您刚创建的机器人链接（如 `@MyEdgeBoxAlert_bot`），进入对话，**然后务必点击底部的 `Start` 按钮**。这是最容易忽略但至关重要的一步。
      * 在 Telegram 中搜索 `@userinfobot`，进入对话并点击 `/start`。
      * 它会立即返回您的个人信息，其中 `Id:` 后面的一串数字就是您的 **Chat ID**。

3.  **在服务器上配置**
    回到 SSH 终端，执行以下命令，将占位符替换为您获取到的真实值。

    ```bash
    edgeboxctl alert telegram <您的Token> <您的Chat ID>
    ```

    **示例：**

    ```bash
    edgeboxctl alert telegram 123456:ABC-DEF_your_token 987654321
    ```

    配置完成后，立即使用 `edgeboxctl alert test` 进行测试。

##### **2. Discord Webhook**
此方法会将告警作为一条消息发送到您指定的 Discord 服务器频道。
- **创建或选择服务器和频道**：在 Discord 中，您可以创建一个新服务器，或使用现有的服务器。
- 点击“＋”添加服务器<img width="250" height="80" alt="image" src="https://github.com/user-attachments/assets/e24bc1a6-5c52-4f82-adca-35b6bf05774f" />
- 点击“亲自创建”<img width="634" height="108" alt="image" src="https://github.com/user-attachments/assets/cde7cbad-9426-41bf-8397-3c372dc0df89" />
- 点击“仅供我和我的朋友使用”<img width="658" height="108" alt="image" src="https://github.com/user-attachments/assets/d8db6c2a-3f85-4f9b-8766-44d3c7691e37" />
- 点击`#常规`
- 点击旁边出现的**齿轮图标 ⚙️**。
- 点击“整合”(Integrations)**
- 点击 **[复制 Webhook URL]**

 **在服务器上配置**
    回到 SSH 终端，执行以下命令。**请注意，必须用单引号 `' '` 将整个 URL 包裹起来**，以防特殊字符导致错误。

    edgeboxctl alert discord '<您的Webhook URL>'

    配置完成后，立即使用 `edgeboxctl alert test` 进行测试。

### **3. 微信 (通过 PushPlus)**

此方法通过第三方服务 `PushPlus推送加`，将告警消息推送到您的个人微信，非常适合国内用户。

1.  **获取 Token**

      * 在微信中搜索并关注公众号：`PushPlus推送加`。
      * 进入公众号，点击底部菜单 **[官网]** -\> **[登录]**，并扫码登录。
      * 在官网页面顶部导航栏点击 **[发送消息]**，您会看到 “**你的token**”。复制这串 Token。

2.  **在服务器上配置**
    回到 SSH 终端，执行以下命令：

    ```bash
    edgeboxctl alert wechat <你的PushPlus Token>
    ```

    配置完成后，立即使用 `edgeboxctl alert test` 进行测试。

#### **4. 通用 Webhook (高级)**

如果您的通知系统（如 Slack、Lark、自建服务等）支持接收 Webhook，可以使用此方式。

```bash
edgeboxctl alert webhook <url> [raw|slack|discord]
```

> **说明**：`format` 参数用于指定发送的 JSON 数据格式以兼容不同平台，默认为 `raw`，即 `{"text":"消息内容"}`。

##### **5. 邮件 (可选)**

此方式需要您手动配置 SMTP 服务器信息，相对复杂，通常不推荐作为首选。脚本已在 `/etc/msmtprc` 生成了配置文件模板，并附有说明文档 `/etc/edgebox/config/email-setup.md` 供参考。

-----

#### **🔍 验证与排错**

如果您在执行 `edgeboxctl alert test` 后未能收到通知，请按以下步骤排查：

1.  **检查配置是否正确**：运行 `edgeboxctl alert show`，仔细核对 Token、Chat ID 或 Webhook URL 是否与您获取的一致。

2.  **检查服务器网络**：在服务器上尝试 `curl` 目标服务的 API 地址，检查网络连通性。

      * **Telegram**: `curl https://api.telegram.org`
      * **Discord/PushPlus**: `curl <您的Webhook/API地址>`
        如果命令长时间无响应或报错，可能是服务器无法访问该服务。

3.  **检查 Telegram 特殊问题**：

      * **是否已 `/start`**：确保您已经对创建的机器人发送过 `/start` 消息。
      * **Chat ID 是否为负数**：如果要发送到群组，Chat ID 通常是负数开头。

4.  **查看告警日志**：

    ```bash
    sudo tail -n 20 /var/log/edgebox-traffic-alert.log
    ```

    日志中可能会记录详细的 `curl` 错误信息。

-----

#### **📚 命令与配置文件参考**

  * **所有命令**

    ```bash
    edgeboxctl alert show                                 # 查看当前告警配置
    edgeboxctl alert monthly <GiB>                        # 设置当月预算
    edgeboxctl alert steps <p1,p2,...>                    # 设置百分比阈值
    edgeboxctl alert telegram <token> <chat_id>           # 配置 Telegram
    edgeboxctl alert discord  <webhook_url>               # 配置 Discord
    edgeboxctl alert wechat   <pushplus_token>            # 配置 PushPlus (微信)
    edgeboxctl alert webhook  <url> [format]              # 配置通用 Webhook
    edgeboxctl alert test [percent]                       # 模拟触发告警
    ```

  * **配置文件路径**: `/etc/edgebox/traffic/alert.conf`

  * **状态文件路径**: `/etc/edgebox/traffic/alert.state` (记录已触发的阈值，防止重复发送)
