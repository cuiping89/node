
# **流量预警与通知渠道配置指南**

EdgeBox 提供了一套强大且灵活的月度流量预警系统。当您服务器的出站流量达到预设的预算百分比时，系统会自动通过您选择的渠道（如 Telegram, Discord, 微信等）发送通知，帮助您有效管理成本，避免因流量超额导致服务中断或产生额外费用。

## **🚀 三步快速入门**

只需三步，即可开启您的流量告警。

1.  **设定预算与阈值**
    通过 `edgeboxctl` 命令设置您服务器的月度流量上限和提醒阶段。

    ```bash
    # 示例：设置本月总流量预算为 200 GiB
    edgeboxctl alert monthly 200

    # 示例：在用量达到 50%、80% 和 95% 时分别发送一次通知
    edgeboxctl alert steps 50,80,95
    ```

2.  **配置至少一个通知渠道**
    从下方选择一个您最方便的渠道，并按照其指南进行配置。我们推荐使用 **Telegram** 或 **微信**。

3.  **测试通知**
    执行测试命令，模拟一次 80% 的流量用量告警，以验证整个通知链路是否通畅。

    ```bash
    edgeboxctl alert test 80
    ```

    执行后，您配置的通知渠道应立即收到一条测试消息。如果没有，请参考文末的 [验证与排错](https://www.google.com/search?q=%23-%E9%AA%8C%E8%AF%81%E4%B8%8E%E6%8E%92%E9%94%99) 部分。

-----

## **⚙️ 渠道配置详解**

### **1. Telegram 机器人 (推荐)**

此方法将创建一个专属的 Telegram 机器人，用于向您发送告警。

1.  **与 `@BotFather` 对话**

      * 在 Telegram 中搜索 `@BotFather` (有官方认证 ✔️ 标志)，进入对话并点击 `/start`。
      * 发送 `/newbot` 命令以创建新机器人。
      * 根据提示，依次为您的机器人设置一个昵称（如 `我的服务器管家`）和唯一的用户名（**必须以 `bot` 结尾**，如 `MyEdgeBoxAlert_bot`）。
      * 创建成功后，BotFather 会返回一条消息，其中包含一串红色的 **Token**。**请务必复制并妥善保管它**。

2.  **启动机器人并获取 Chat ID**

      * 点击 BotFather 消息中您刚创建的机器人链接（如 `@MyEdgeBoxAlert_bot`），进入对话，**然后务必点击底部的 `Start` 按钮**。这是最容易忽略但至关重要的一步。
      * 在 Telegram 中搜索 `@userinfobot`，进入对话并点击 `/start`。
      * 它会立即返回您的个人信息，其中 `Id:` 后面的一串数字就是您的 **Chat ID**。

3.  **在服务器上配置**
    回到 SSH 终端，执行以下命令，将占位符替换为您获取到的真实值。

    ```bash
    edgeboxctl alert telegram <您的Token> <您的Chat ID>
    ```

    **示例：**

    ```bash
    edgeboxctl alert telegram 123456:ABC-DEF_your_token 987654321
    ```

    配置完成后，立即使用 `edgeboxctl alert test` 进行测试。

### **2. Discord Webhook**

此方法会将告警作为一条消息发送到您指定的 Discord 服务器频道。

1.  **在 Discord 中创建 Webhook**

      * 打开您的 Discord 服务器，选择一个您想接收通知的频道。
      * 点击频道名称旁的**齿轮图标 ⚙️** 进入“编辑频道”。
      * 在左侧菜单中选择“**整合 (Integrations)**”。
      * 点击“**创建 Webhook**”按钮。
      * 您可以为这个 Webhook 自定义一个名称（例如 `EdgeBox Alerter`）和头像。
      * 点击 **[复制 Webhook URL]** 按钮，并妥善保管这个 URL。

2.  **在服务器上配置**
    回到 SSH 终端，执行以下命令。**请注意，必须用单引号 `' '` 将整个 URL 包裹起来**，以防特殊字符导致错误。

    ```bash
    edgeboxctl alert discord '<您的Webhook URL>'
    ```

    配置完成后，立即使用 `edgeboxctl alert test` 进行测试。

### **3. 微信 (通过 PushPlus)**

此方法通过第三方服务 `PushPlus推送加`，将告警消息推送到您的个人微信，非常适合国内用户。

1.  **获取 Token**

      * 在微信中搜索并关注公众号：`PushPlus推送加`。
      * 进入公众号，点击底部菜单 **[官网]** -\> **[登录]**，并扫码登录。
      * 在官网页面顶部导航栏点击 **[发送消息]**，您会看到 “**你的token**”。复制这串 Token。

2.  **在服务器上配置**
    回到 SSH 终端，执行以下命令：

    ```bash
    edgeboxctl alert wechat <你的PushPlus Token>
    ```

    配置完成后，立即使用 `edgeboxctl alert test` 进行测试。

### **4. 通用 Webhook (高级)**

如果您的通知系统（如 Slack、Lark、自建服务等）支持接收 Webhook，可以使用此方式。

```bash
edgeboxctl alert webhook <url> [raw|slack|discord]
```

> **说明**：`format` 参数用于指定发送的 JSON 数据格式以兼容不同平台，默认为 `raw`，即 `{"text":"消息内容"}`。

-----

## **📖 命令与文件参考**

### **所有命令**

```bash
# 查看当前所有预警配置
edgeboxctl alert show

# 设置月度总流量预算，单位为 GiB
edgeboxctl alert monthly <GiB>

# 设置触发预警的百分比阈值，多个值用逗号分隔
edgeboxctl alert steps <p1,p2,...>

# 配置 Telegram 通知渠道
edgeboxctl alert telegram <bot_token> <chat_id>

# 配置 Discord 通知渠道
edgeboxctl alert discord <webhook_url>

# 配置微信 PushPlus 通知渠道
edgeboxctl alert wechat <pushplus_token>

# 配置通用 Webhook，可选格式 [raw|slack|discord]
edgeboxctl alert webhook <url> [format]

# 发送一条测试通知，可指定模拟的百分比
edgeboxctl alert test [percent]
```

### **相关文件**

  * **配置文件**: `/etc/edgebox/traffic/alert.conf`
      * 这个文件保存了您的所有预警设置。您也可以直接编辑此文件，但推荐使用 `edgeboxctl` 命令进行管理。
  * **状态文件**: `/etc/edgebox/traffic/alert.state`
      * 此文件用于记录**已经触发过**的百分比阈值，以防止在同一个阈值上重复发送通知。`edgeboxctl alert test` 命令会自动重置此文件。
  * **日志文件**: `/var/log/edgebox-traffic-alert.log`
      * 记录了每次预警脚本运行和发送通知的详细日志，是排查问题的首选。

-----

## **🔍 验证与排错**

如果您在执行 `edgeboxctl alert test` 后未能收到通知，请按以下步骤排查：

1.  **检查配置是否正确**：运行 `edgeboxctl alert show`，仔细核对 Token、Chat ID 或 Webhook URL 是否与您获取的一致，特别是检查有无遗漏或多余的字符。

2.  **检查服务器网络**：在服务器上尝试 `curl` 目标服务的 API 地址，检查网络连通性。

      * **Telegram**: `curl https://api.telegram.org`
      * **Discord/PushPlus**: `curl <您的Webhook/API地址>`
        如果命令长时间无响应或报错，可能是您的服务器无法访问该服务。

3.  **检查 Telegram 特殊问题**：

      * **是否已 `/start`**：这是最常见的问题。请确保您已经对您创建的机器人发送过 `/start` 消息。
      * **Chat ID 是否为负数**：如果您希望将通知发送到**群组**，Chat ID 通常是负数开头，请确保没有遗漏负号。

4.  **查看告警日志**：这是最有效的排错方式。

    ```bash
    sudo tail -n 20 /var/log/edgebox-traffic-alert.log
    ```

    日志中可能会记录详细的 `curl` 错误信息或其他失败原因。
