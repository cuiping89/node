
# **高级安全增强功能指南**

EdgeBox 不仅仅是提供多种协议，它还内置了一套先进的自动化安全系统，旨在动态地增强您连接的隐蔽性和健壮性，最大限度地降低被识别和干扰的风险。

本指南将向您介绍三大核心安全特性：**Reality 密钥轮换**、**SNI 域名池管理** 和 **流量特征随机化**。

-----

## **1. Reality 密钥轮换系统**

### 这是什么？

可以将其理解为您 Reality 协议连接的“锁和钥匙”。为了安全，这套“锁和钥匙”不应该永久不变。EdgeBox 的密钥轮换系统会自动在一定周期后（默认为60天）为您生成一套全新的密钥对。

### 它有什么好处？

  * **降低长期暴露风险**：长期使用同一套密钥会增加被特征分析和识别的可能性。定期轮换就像定期更换门锁，让潜在的攻击者无法长期盯防。
  * **提升安全性**：即使旧密钥在未来某个时刻被破解，由于您已经更换了新密钥，历史流量的安全性依然得到保障。

### 我需要做什么？

**几乎什么都不用做。** 系统已经为您配置了定时任务，会在后台自动检查并执行轮换。

如果您想手动管理，可以使用以下命令：

| 命令 | 功能说明 |
| :--- | :--- |
| `edgeboxctl reality-status` | 查看当前密钥的状态，包括上次轮换时间和下次计划轮换的时间。 |
| `edgeboxctl rotate-reality` | 手动立即触发一次密钥轮换。 |
| `edgeboxctl rotate-reality --force` | 强制执行轮换，忽略冷却时间限制。 |
| `edgeboxctl rotate-sid` | 无缝轮换 Reality 的 `shortId`。这是一个更轻量级的操作，系统也会定期自动执行，为您的连接提供另一层动态变化。 |

-----

## **2. SNI 域名池智能管理**

### 这是什么？

当您使用 Reality 协议时，您的连接会伪装成访问一个真实的、知名的大网站（如 `www.microsoft.com`）。这个用来伪装的域名就是 SNI。如果长期只伪装成访问同一个网站，也可能形成一种固定的行为特征。

SNI 域名池管理系统会自动从一个包含多个知名网站（如微软、苹果、Cloudflare）的“伪装目标池”中，智能地测试并选择一个当前访问质量最好的域名来作为您的伪装目标。

### 它有什么好处？

  * **动态伪装，避免特征固化**：定期更换伪装目标，让您的流量每次看起来都像是在访问不同的热门网站，从而打破行为定势，大幅提升隐蔽性。
  * **保证连接质量**：系统会自动选择延迟最低、最稳定的域名作为伪装目标，确保您的 Reality 连接始终保持在最佳状态。

### 我需要做什么？

**同样，几乎什么都不用做。** 系统已配置了每周一次的定时任务，会自动为您选择最优的 SNI 域名。

如果您想手动管理，可以使用以下命令：

| 命令 | 功能说明 |
| :--- | :--- |
| `edgeboxctl sni auto` | **（推荐）** 立即手动触发一次智能选择，系统会自动测试并应用当前最优的 SNI 域名。 |
| `edgeboxctl sni list` | 查看当前域名池中有哪些可用的伪装域名及其状态。 |
| `edgeboxctl sni test-all` | 对池中所有域名进行一次连通性测试。 |
| `edgeboxctl sni set <域名>` | 手动强制指定一个伪装域名，例如 `edgeboxctl sni set www.apple.com`。 |

-----

## **3. 流量特征随机化**

### 这是什么？

除了伪装访问目标（SNI），不同代理协议的流量在数据包大小、发送间隔等方面也存在细微的“行为特征”。流量特征随机化功能会自动、定期地微调 Hysteria2 和 TUIC 等协议的一些底层参数（如伪装站点），目的是让流量的“行为”看起来更随机、更像普通用户的网络活动。

### 它有什么好处？

  * **对抗 DPI 指纹识别**：通过参数的动态变化，使得基于固定指纹的深度包检测（DPI）更难识别出您的代理流量。
  * **增强隐蔽性**：让您的流量模式“淹没”在海量的普通互联网流量中。

### 我需要做什么？

**依然是全自动的。** 系统已经为您配置了不同周期的定时任务，会自动执行不同程度的随机化。

如果您想手动管理，可以使用以下命令：

| 命令 | 功能说明 |
| :--- | :--- |
| `edgeboxctl traffic randomize [level]` | 手动执行一次流量特征随机化。您可以指定级别：`light`（轻度，每日执行）、`medium`（中度，每周执行）、`heavy`（重度，每月执行）。 |
| `edgeboxctl traffic status` | 查看随机化系统的当前状态和定时任务配置。 |
| `edgeboxctl traffic reset` | 将所有协议参数重置为脚本的默认值。 |

**总结**: EdgeBox 的高级安全功能被设计为“即装即忘”的全自动化系统。您无需进行任何额外操作，就能享受到持续的、动态的安全防护。`edgeboxctl` 提供的命令则是您在需要时进行检查和手动干预的强大工具。

-----

### **版本二：面向开发者的技术设计文档**

这个版本基本保留了您原始文档的精华，即技术深度和设计思路。它适合放入 `docs/开发者文档 (For Developers)/` 目录，可以命名为 `03-安全增强架构设计.md`，供您自己或其他贡献者参考。

```markdown
# EdgeBox 安全增强功能架构设计

> **版本**: v1.0
> **文档用途**: 阐述 EdgeBox 核心安全功能（密钥轮换、SNI管理、流量随机化）的技术实现原理、设计决策与开发规范。

---

## **1. 改进概述**

### **1.1 安全理论基础**

EdgeBox 的安全改进遵循以下核心原则：
-   **加密正确性**：确保密码学实现无误。
-   **流量形态优化**：降低被 DPI/指纹识别的概率。
-   **端点信誉保护**：避免 IP/域名因特征固化而被标记。
-   **运维自动化**：通过自动化任务减少人工干预，提升安全性与健壮性。

### **1.2 核心功能模块**

| 优先级 | 项目名称 | 安全价值 | 实施复杂度 |
| :--- | :--- | :--- | :--- |
| 🔥 最高 | Reality 密钥轮换 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 🔥 最高 | SNI 域名池管理 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 🚀 高 | 流量特征随机化 | ⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## **2. Reality 密钥轮换系统**

### **2.1 设计目标**

-   **定期轮换**: 自动定期更换 Reality 协议的公私钥对，避免长期使用固定密钥带来的安全风险。
-   **自动化管理**: 通过 `systemd-run` 或 `cron` 实现无人值守的周期性任务。
-   **无缝切换**: `rotate-sid` 命令通过追加新 `shortId` 并设置延时清理任务的方式，为客户端提供平滑过渡期。

### **2.2 技术实现**

-   **密钥生成**: 直接调用 `sing-box generate reality-keypair` 命令生成新的密钥对。
-   **配置更新**:
    1.  **`rotate-reality`**: 使用 `jq` 同时更新 `server.json` (更新公钥、私钥、shortId) 和 `xray.json` (仅更新私钥和 shortId)。
    2.  **`rotate-sid`**: 使用 `jq` 向 `xray.json` 的 `shortIds` 数组中追加新的 `shortId`，并安排一个延时任务在宽限期结束后移除旧的 `shortId`。
-   **状态管理**: 在 `/etc/edgebox/config/reality-rotation.json` 文件中记录上次轮换时间、下次计划时间以及当前公钥，作为 `check_reality_rotation_needed` 函数的判断依据。
-   **服务重载**: 更新配置后，执行 `systemctl reload xray` 或 `restart` 使新密钥生效。
-   **订阅刷新**: 轮换后，立即调用 `regen_sub_ip` 或 `regen_sub_domain` 刷新订阅文件，确保用户能获取到包含新公钥和 `shortId` 的配置。

---

## **3. SNI 域名池智能管理**

### **3.1 设计目标**

-   **动态 SNI**: 避免 Reality 协议长期伪装成同一个目标站点。
-   **智能评分**: 基于可达性、响应时间、证书有效性等维度对备选域名进行评分，选择最优者。
-   **自动轮换**: 通过定时任务定期执行智能选择和切换。

### **3.2 技术实现**

-   **域名池配置**: 备选域名硬编码在 `install.sh` 的 `SNI_DOMAIN_POOL` 数组中，并在安装时写入 `/etc/edgebox/config/sni/domains.json`。
-   **评分算法 (`evaluate_sni_domain`)**:
    1.  **可达性**: 使用 `curl` 测试 HTTPS 可访问性 (40分)。
    2.  **响应时间**: 使用 `curl` 获取 `time_total`，根据耗时分档计分 (10-30分)。
    3.  **SSL 证书验证**: 使用 `openssl s_client` 验证证书链 (20分)。
    4.  **类别加分**: 对 `microsoft.com`, `apple.com` 等顶级域名给予额外加分 (10分)。
-   **配置更新 (`update_sni_domain`)**:
    1.  **无缝切换**: 使用 `jq` 向 `xray.json` 的 `serverNames` 数组中同时加入新旧两个域名。
    2.  **延时清理**: 安排一个 `systemd-run` 延时任务，在宽限期（如24小时）后，从配置中移除旧的 SNI 域名。
    3.  **多文件同步**: 同时更新 `xray.json` (后端服务) 和 `server.json` (前端数据源)，并刷新订阅文件，确保数据一致性。

---

## **4. 流量特征随机化**

### **4.1 设计目标**

-   **降低指纹特征**: 通过定期改变协议的非关键参数，使流量模式多样化，对抗基于固定特征的检测。
-   **分级策略**: 提供 `light`, `medium`, `heavy` 三种不同深度和频率的随机化策略，以平衡隐蔽性和稳定性。
-   **自动化调度**: 通过 `cron` 任务实现不同级别策略的自动化执行。

### **4.2 技术实现**

-   **参数定义**: 可随机化的参数（如 Hysteria2 的伪装站点）被定义在 `edgebox-traffic-randomize.sh` 脚本内部的数组中。
-   **随机化函数**:
    -   `randomize_hysteria2_config`: 从预设的 URL 列表中随机选择一个，并使用 `jq` 更新 `sing-box.json` 中的 `masquerade` 字段。
    -   `randomize_tuic_config`: 确保 `congestion_control` 设置为 `bbr`。
-   **安全机制**:
    -   **备份**: 在修改配置前，自动备份当前的 `xray.json` 和 `sing-box.json`。
    -   **验证**: 修改后，调用 `sing-box check` 或 `xray -test` 验证新配置的语法正确性。
    -   **回滚**: 如果验证失败，脚本会自动从备份中恢复上一版配置。
-   **调度执行**: 在主安装脚本中，通过 `setup_cron_jobs` 函数将不同级别的随机化命令写入 `crontab`，实现每日、每周、每月的自动执行。
```
