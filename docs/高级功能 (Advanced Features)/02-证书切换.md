
# **EdgeBox 证书与模式切换深度指南**

本文档旨在深入说明 EdgeBox 的两种核心运行模式——**IP 模式**和**域名模式**——以及它们背后的 TLS 证书管理机制。理解这些内容将帮助您更好地选择适合自己场景的配置，并从容应对相关问题。

## **1. 理解两种核心模式**

EdgeBox 的设计允许它在两种截然不同的 TLS 处理模式下工作，以适应不同用户的需求。

### **IP 模式 (默认)**

  * **核心特征**: 无需域名，开箱即用。
  * **证书类型**: 使用自动生成的**自签名证书**。
  * **工作原理**: 由于证书是“自制”的，它不受公共信任。因此，客户端（如 v2rayN, Clash 等）在连接 VLESS-gRPC/WS, Trojan, Hysteria2, TUIC 等需要 TLS 加密的协议时，必须配置为 **"跳过证书验证"** 或 **"允许不安全连接"**。`edgeboxctl sub` 生成的订阅链接会自动包含这些参数。
  * **适用场景**:
      * 刚完成系统安装，希望立即开始使用。
      * 用户没有自己的域名。
      * 主要依赖 VLESS-Reality 协议（该协议不依赖此证书）。

### **域名模式**

  * **核心特征**: 使用您自己的域名，提供完全受信任的 TLS 连接。
  * **证书类型**: 使用由 Let's Encrypt 颁发的**受信任的 CA 证书**。
  * **工作原理**: `edgeboxctl` 会自动为您的域名（以及 `trojan` 子域名）申请证书。由于该证书是公共信任的，任何客户端在连接时都会验证通过，无需任何“允许不安全”的特殊设置。这使得连接行为与访问普通 HTTPS 网站完全一致，具备更好的伪装性。
  * **适用场景**:
      * 拥有自己的域名并希望获得最佳安全性和兼容性的用户。
      * 希望所有协议（包括 gRPC/WS/Trojan）的 TLS 流量都看起来完全正常。

> **核心区别**: 两种模式的本质区别在于 **TLS 证书的信任来源**。IP 模式是“我给自己担保”，客户端需要被告知“信任我”；域名模式是“由权威机构为你担保”，任何客户端都默认信任。

-----

## **2. 如何进行模式切换**

`edgeboxctl` 工具让模式切换变得简单而安全。

### **切换到域名模式（推荐）**

这是从默认 IP 模式升级到更安全、更标准配置的过程。

**前提条件:**

1.  您拥有一个域名（例如 `mydomain.com`）。
2.  您已经将该域名（`mydomain.com`）和 `trojan.mydomain.com` 子域名的 A 记录解析到您的服务器 IP 地址。

**执行命令:**

```bash
edgeboxctl switch-to-domain mydomain.com
```

**背后发生了什么？**

1.  **解析验证**: 脚本会检查您的域名是否正确指向当前服务器。
2.  **证书申请**: `certbot` 工具会自动启动，通过 `nginx` 插件向 Let's Encrypt 申请覆盖 `mydomain.com` 和 `trojan.mydomain.com` 的证书。
3.  **更新软链接**: `/etc/edgebox/cert/current.pem` 和 `current.key` 这两个软链接会从指向自签名证书，改为指向新申请的 Let's Encrypt 证书。
4.  **配置更新**:
      * Nginx, Xray, 和 sing-box 的配置会重新加载，以使用新的 CA 证书。
      * Nginx 的流量分发逻辑也会相应调整，以适配域名模式下的 SNI 规则。
5.  **订阅刷新**: 脚本会重新生成订阅链接，移除所有 `allowInsecure=1` 之类的参数，因为不再需要它们了。
6.  **自动验证**: 命令结束后会输出一份“验收报告”，检查服务、端口和证书状态，确保切换成功。

### **切换回 IP 模式**

如果您不再想使用域名，可以随时回退。

**执行命令:**

```bash
edgeboxctl switch-to-ip
```

**背后发生了什么？**

1.  **更新软链接**: 证书软链接会重新指向 `/etc/edgebox/cert/self-signed.pem` 和 `self-signed.key`。
2.  **配置复原**: 所有服务的配置都会恢复到使用自签名证书的初始状态。
3.  **订阅刷新**: 重新生成的订阅链接会再次带上 `allowInsecure=1` 等参数，以确保客户端可以连接。

-----

## **3. 证书管理与维护**

### **查看证书状态**

随时检查您证书的健康状况。

```bash
edgeboxctl cert status
```

此命令会清晰地显示当前证书的模式、绑定的域名、颁发者以及最重要的——**到期日期和剩余天数**。

### **手动续期证书**

EdgeBox 在安装时会自动为您配置好 Certbot 的定时续期任务。通常情况下，您**无需**手动续期。但如果遇到特殊情况或想要立即续期，可以执行：

```bash
edgeboxctl cert renew
```

该命令会调用 `certbot renew`，安全地完成续期并自动重载相关服务。

### **修复证书权限**

如果您手动上传或修改了证书文件，可能会遇到文件权限问题，导致 Nginx 或 Xray 无法读取。

```bash
edgeboxctl fix-permissions
```

此命令会将证书目录和文件的所有者、权限恢复到 EdgeBox 要求的标准状态，一键解决权限问题。
