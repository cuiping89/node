# **自动备份与恢复指南**

EdgeBox 内置了一套强大而可靠的自动备份与手动恢复机制，旨在最大限度地保障您的配置安全，让您在遇到意外情况（如配置错误、服务器故障）时能够从容应对，快速恢复服务。

## **1. 自动备份机制**

为了让您高枕无忧，EdgeBox 默认启用了一项全自动的每日备份任务。

* **工作原理**：系统通过一个定时任务，在每天的固定时间（默认为凌晨3点）自动执行一次全配置备份。
* **备份内容**：备份是一个完整的系统快照，包含了所有恢复 EdgeBox 所需的关键组件：
    * **核心配置**：`/etc/edgebox/` 目录下的所有文件，包括 `server.json`, `xray.json`, `sing-box.json` 等。
    * **证书文件**：`/etc/letsencrypt/` 目录下的所有 Let's Encrypt 证书以及 EdgeBox 的自签名证书。
    * **Nginx 配置**：主配置文件 `nginx.conf`。
    * **服务单元文件**：`xray.service` 和 `sing-box.service` 的定义文件。
    * **定时任务**：您当前的所有 `cron` 任务。
* **存储位置**：所有的备份文件都以 `.tar.gz` 格式存放在 `/root/edgebox-backup/` 目录下。
* **自动清理**：为了节省磁盘空间，系统会自动清理旧的备份，仅保留最近的 **10** 份。

> 💡 **一句话总结**：您无需任何操作，系统每天都会自动为您保存一份可用于“时光倒流”的完整配置快照。

---

## **2. 手动管理备份 (`edgeboxctl backup`)**

除了自动备份，`edgeboxctl` 工具也提供了完整的手动管理能力，让您可以随时创建、查看和恢复备份。

| 命令 | 功能说明 |
| :--- | :--- |
| `edgeboxctl backup create` | **手动创建备份**。立即执行一次完整的配置备份，生成一个新的备份文件。 |
| `edgeboxctl backup list` | **列出所有备份**。显示当前 `/root/edgebox-backup/` 目录下所有可用的备份文件及其创建时间和大小。 |
| `edgeboxctl backup restore <文件名>` | **（核心）从备份恢复**。使用指定的备份文件覆盖当前所有配置，并自动重启相关服务，让系统恢复到备份时的状态。 |

### **使用示例**

* **在进行一次重要配置变更前，手动创建一个备份：**
    ```bash
    edgeboxctl backup create
    ```

* **查看当前有哪些可用的恢复点：**
    ```bash
    edgeboxctl backup list
    ```

---

## **3. 恢复流程（灾难恢复）**

假设您因为一次错误的配置修改导致服务完全无法启动，此时可以按照以下步骤快速恢复：

1.  **列出可用备份**：
    首先，执行 `edgeboxctl backup list` 查看所有备份文件，选择一个您确认当时系统状态正常的备份文件。
    ```bash
    edgeboxctl backup list
    ```
    输出可能如下：
    ```
    /root/edgebox-backup/edgebox_backup_20251016_030001.tar.gz  1.2M  ...
    /root/edgebox-backup/edgebox_backup_20251017_030001.tar.gz  1.2M  ...
    ```

2.  **执行恢复命令**：
    复制您选择的文件名，然后执行 `restore` 命令。
    ```bash
    edgeboxctl backup restore /root/edgebox-backup/edgebox_backup_20251017_030001.tar.gz
    ```

3.  **等待完成**：
    脚本会自动解压备份文件，将所有配置覆盖回原来的位置，然后重新加载并启动所有核心服务。整个过程通常在几秒钟内完成。

4.  **验证状态**：
    恢复完成后，立即运行 `edgeboxctl status` 检查所有服务是否都已恢复到 `active (running)` 状态。

## **4. 重要提示**

* **数据范围**：备份系统主要关注**配置文件**和**服务定义**，它**不包含**海量的流量日志数据（如 `/var/log/` 下的文件），以保持备份文件的轻量化。
* **定期检查**：建议您偶尔运行 `edgeboxctl backup list`，以确认自动备份任务是否在正常执行。
* **异地备份**：为了获得终极的数据安全，建议您定期将 `/root/edgebox-backup/` 目录下的最新备份文件通过 `scp` 或 `sftp` 等工具下载到您的本地电脑或其他安全的存储位置。
