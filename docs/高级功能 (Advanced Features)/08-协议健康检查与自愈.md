
# **协议健康检查与自愈系统**

为了确保 EdgeBox 节点7x24小时的稳定运行，系统内置了一套强大的自动化“运维机器人”——协议健康检查与自愈系统。它会不知疲倦地在后台巡检，自动发现并修复大部分常见故障。

## **1. 这是什么功能？**

这是一个主动式的、深度的监控和修复系统，远比简单的“服务是否在运行”检查要智能得多。它通过一个名为 `protocol-health-monitor.sh` 的脚本，定时（默认每5分钟）对所有已部署的协议进行全方位的健康检查。

### **它会检查什么？**

  * **服务存活状态**：`systemctl is-active` 检查 `xray`, `sing-box`, `nginx` 是否在运行。
  * **端口监听状态**：使用 `ss` 命令确认每个协议所需的公网和内部端口是否都处于监听状态。
  * **TLS 握手测试**：模拟客户端向 `443` 端口发起 TLS 握手，验证 Nginx 和后端服务的 TLS 功能是否正常。
  * **日志分析**：对于 Hysteria2 和 TUIC 等 UDP 协议，系统会分析其服务日志，寻找近期有成功连接记录的迹象，以判断其真实可用性。

### **它能自动修复什么 (自愈)？**

当检测到异常时，系统会像一个经验丰富的运维工程师一样，尝试执行一系列修复操作：

  * **服务停止** -\> `尝试重启服务`
  * **端口未监听** -\> `检查配置文件并重启服务`
  * **TLS 握手失败** -\> `检查证书文件权限，若损坏则尝试重新生成，然后重启服务`
  * **防火墙阻断 (UDP)** -\> `自动添加 UFW/firewalld 规则放行相应端口`

-----

## **2. 熔断机制：防止问题扩大**

为了避免在严重故障（如配置文件损坏）的情况下，系统不断地、无效地重启服务，我们引入了“熔断器”机制。

  * **工作原理**：如果系统在**10分钟内**尝试重启同一个服务失败**超过3次**，它将触发熔断。
  * **触发后行为**：系统会**暂停**对该服务的自动修复，并生成一条高优先级的告警通知（如果您配置了通知渠道），提示需要人工介入。这可以有效防止日志爆炸和资源浪费。

## **3. 它为我带来了什么好处？**

  * **高可用性**：大部分常见的软件问题，如服务意外崩溃、端口监听失败等，都会在您察觉之前被系统自动修复，最大化保障了服务的在线时间。
  * **减少人工运维**：您无需时刻登录服务器检查状态，自愈系统是您的“7x24小时运维助理”。
  * **智能诊断**：控制面板上显示的协议“运行状态”（如“健康”、“降级”、“异常”）正是基于这套深度检查的结果，为您提供了更精准、更可信的服务状态视图。

## **4. 我需要做什么？**

**完全无需任何操作。** 这套系统在 EdgeBox 安装时已自动配置并启用。您只需享受它带来的高稳定性即可。

如果您想查看它的工作记录，可以查阅日志文件：

```bash
# 查看健康检查与自愈的详细日志
tail -n 100 /var/log/edgebox/health-monitor.log
```

