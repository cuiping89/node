
# **出站路由与分流深度指南**

EdgeBox 提供了强大且灵活的出站路由分流系统，允许您精细化地控制服务器流量的出口路径。这对于管理流量成本、维持账号画像纯净度以及应对不同网络需求至关重要。

## **1. 理解三种出站模式**

您可以通过 `edgeboxctl` 命令在以下三种互斥的模式间切换：

| 模式 | 命令 | 功能说明 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **VPS 直连 (默认)** | `vps` | **所有流量**都通过您服务器的 IP 地址直接访问互联网。 | 这是最稳定、最简单的模式，适合绝大多数日常使用场景。 |
| **代理全量出站** | `resi <URL>` | **所有流量**都通过您指定的上游代理（如住宅 IP）进行转发。 | 当您需要将所有网络行为都伪装成来自特定代理 IP 时使用。 |
| **智能分流** | `direct-resi <URL>` | **白名单内的域名走 VPS 直连**，其余所有**未在白名单的流量走代理**。 | **（推荐）** 兼顾成本与账号画像的最佳模式。例如，将大流量的视频 CDN 域名加入白名单直连以节省代理流量，而将敏感的登录、支付请求走代理以维持账号纯净度。 |

### **⚠️ 关键技术说明：分流仅对 Xray 生效**

这是一个必须理解的核心机制：

  * **分流范围**：出站分流策略**仅对通过 Xray 处理的协议生效**，即 **VLESS 系列**和 **Trojan-TLS**。
  * **直连协议**：**Hysteria2** 和 **TUIC** 这两个基于 UDP 的协议，为了保证其最佳性能和连接可靠性，**始终通过 VPS 直接连接**，它们**不参与**上述任何分流策略。

> **简而言之**：当您需要利用代理 IP 维持账号画像时，请确保客户端使用的是 VLESS 或 Trojan 协议。Hysteria2/TUIC 会继续作为高效的 UDP 通道存在，不受分流模式影响。

-----

## **2. 管理命令参考**

所有出站管理都通过 `edgeboxctl shunt` 子命令完成。

### **模式切换**

  * **切换到 VPS 直连模式（默认）：**

    ```bash
    edgeboxctl shunt vps
    ```

  * **切换到代理全量出站模式：**

    ```bash
    edgeboxctl shunt resi '<您的代理URL>'
    ```

  * **切换到智能分流模式：**

    ```bash
    edgeboxctl shunt direct-resi '<您的代理URL>'
    ```

    > **[\!] 重要**: 代理 URL 因为可能包含特殊字符，**必须用单引号 `' '` 包裹起来**。

### **状态查看**

  * **查看当前状态：**
    ```bash
    edgeboxctl shunt status
    ```
    此命令会显示当前的出站模式、上游代理的连通性以及真实的出口 IP 地址。

### **白名单管理 (仅用于 `direct-resi` 模式)**

  * **查看当前白名单列表：**

    ```bash
    edgeboxctl shunt whitelist list
    ```

  * **向白名单添加一个或多个域名：**

    ```bash
    edgeboxctl shunt whitelist add <域名1> <域名2>
    ```

  * **从白名单移除一个或多个域名：**

    ```bash
    edgeboxctl shunt whitelist remove <域名1> <域名2>
    ```

  * **重置为项目推荐的默认白名单：**

    ```bash
    edgeboxctl shunt whitelist reset
    ```

### **[\!] 如何让白名单修改生效**

在您**修改（添加、删除、重置）了白名单之后**，新的规则**不会**自动生效。您必须**重新执行一次 `shunt direct-resi` 命令**来让 Xray 加载新的规则集。

```bash
# 示例：在添加了 netflix.com 到白名单后，执行此命令以应用更改
edgeboxctl shunt direct-resi '<您的代理URL>'
```

-----

## **3. 智能分流：白名单维护原则**

`direct-resi` 模式的精髓在于白名单的科学维护。核心原则是：

**只将承载大流量且与账号身份弱关联的 CDN 域名加入白名单。**

通俗地讲，就是把“干活的牛”（传输视频、大文件的服务器）和“发指令的人”（登录、点赞、评论的服务器）分开。我们让“牛”走 VPS 直连，让“人”走代理。

| 类别 | 流量特征 | 账号画像影响 | 示例 | 建议操作 |
| :--- | :--- | :--- | :--- | :--- |
| **应用/API 域名** | 流量小，但包含用户认证、行为元数据 | **极高** | `youtube.com`, `netflix.com`, `api.twitter.com` | **严禁**加入白名单（必须走代理） |
| **CDN 域名** | 流量巨大，主要是视频、音频、图片等 | **极低** | `googlevideo.com`, `nflxvideo.net`, `ttvnw.net` | **强烈推荐**加入白名单（可以直连） |

### **推荐的默认白名单 (美区)**

EdgeBox 已内置一套针对美区主流流媒体优化的白名单，您可以通过 `edgeboxctl shunt whitelist reset` 命令一键恢复。

```
# YouTube
googlevideo.com
# Netflix
nflxvideo.net
# Disney+ / Hulu
dssott.com
# Amazon Prime Video
aiv-cdn.net
aiv-delivery.net
# Twitch
ttvnw.net
# HBO Max (Max)
hbo-cdn.com
# Apple TV+ / Music
hls.itunes.apple.com
# Spotify
scdn.co
# TikTok
tiktokcdn.com
```

这个列表为您涵盖了美区最主流的“流量大户”，在确保账号安全的前提下，最大限度地节省了您的代理流量。

### **高级技巧：如何发现新的 CDN 域名？**

当您在浏览器中播放某个视频时，可以打开“开发者工具”（通常按 F12），切换到“网络(Network)”选项卡，并按“大小(Size)”排序。您会看到一些体积非常大的文件（通常是 `.mp4`, `.ts`, `.m4s` 等格式），查看这些请求的域名，通常就是该服务的 CDN 域名。然后使用 `edgeboxctl shunt whitelist add <新发现的CDN域名>` 将其添加即可。
