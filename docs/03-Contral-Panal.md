
````markdown
# EdgeBox 控制面板 - V2 技术规范

本文档为 EdgeBox 控制面板 V2 版本的技术实现规范，旨在为前端开发提供清晰的布局、内容、状态及接口约定。

## 1. 核心理念与统一口径

新版面板的核心是**信息分层**与**状态清晰**。通过模块化的卡片布局，将不同维度的数据进行逻辑隔离，为用户提供更聚焦、更有条理的视觉体验。

### 1.1 术语与命名（统一口径）

为确保前后端开发与最终用户体验的一致性，所有组件和状态的命名需严格遵守以下口径：

* **通用术语**: 使用“出站”而非“出口”。
* **卡片标题**: `网络身份配置`
* **出站模式枚举**: `直连` (Direct), `全代理` (Full-Proxy), `混合` (Shunt)
* **证书类型**: `Let's Encrypt`, `自签名`
* **空值显示**:
    * 数据获取中或未知: 统一显示 `—`
    * 配置未设置或不存在: 统一显示 `(无)`

## 2. 页面布局（12栅格系统）

页面采用响应式的12栅格系统进行布局。

* **第一行: 概览信息**
    * `服务器信息` (占4列)
    * `服务器配置` (占4列)
    * `核心服务` (占4列)
* **第二行: 核心配置**
    * `证书切换` (占4列)
    * `网络身份配置` (占8列)
* **第三行: 协议详情**
    * `协议配置` (占12列，整行)
* **第四行: 常用功能**
    * `订阅链接` (占12列)
    * `流量统计` (占12列)

## 3. 卡片内容与交互规范

### 3.1 服务器信息 (Card)
* **用户备注名**: 纯文本。
* **云厂商/区域**: 格式为 `<提供商> | <Region>` (例: `GCP | us-central1`)。
* **Instance ID**: 纯文本。
* **主机名 (Hostname)**: 纯文本。

### 3.2 服务器配置 (Card)
* **CPU**: 进度条组件。显示 `已用 <pct>%`，后缀附加灰色小字说明，格式为 `<物理核心>C / <线程>T`。
* **内存**: 进度条组件。显示 `已用 <pct>%`，后缀附加灰色小字说明，格式为 `<总内存>GiB + <虚拟内存>GiB`。
* **磁盘**: 进度条组件。显示 `已用 <pct>%`，后缀附加灰色小字说明，格式为 `<总量>GiB`。

### 3.3 核心服务 (Card)
* **服务列表**: Nginx, Xray, Sing-box 分别显示状态 `运行中 / 已停止 / 异常 / 未安装`，并附带版本号。
* **交互**: (可选) 点击“详情”可展开显示最近50行服务日志。

### 3.4 证书切换 (Card)
* **模式标签**: 卡片顶部放置两个标签：“自签证书”、“CA证书”，当前激活的模式标签显示为高亮状态（如绿色）。
* **证书类型**: `Let's Encrypt` / `自签名`。
* **绑定域名**: 显示域名字符串，如 `example.com`；若无则显示 `(无)`。
* **续期方式**: `自动` / `手动`。
* **到期日期**: 格式为 `YYYY-MM-DD`；自签名证书显示 `—`。

### 3.5 网络身份配置 (Composite Card)
这是一个组合卡片，顶部有三个模式标签：“VPS出站IP”、“代理出站IP”、“分流出站”，高亮显示当前激活的模式。

#### a) VPS出站IP (Sub-section)
* **公网身份**: `直连`
* **VPS出站IP**: 显示IP地址。
* **ASN/ISP**: 字符串 (例: `AS15169 / Google`)。
* **Geo**: 格式为 `国家代码-城市` (例: `US-Los Angeles`)。
* **带宽限制**: 格式为 `上行 <Mbps> / 下行 <Mbps>` (未知则显示 `— / —`)。
* **IP质量检测**: `IP质量：<score>分（<verdict>），详情`。

#### b) 代理出站IP (Sub-section)
* **代理身份**: `全代理`
* **数据内容**: `代理出站IP`, `ASN/ISP`, `Geo`, `带宽限制` 字段同上，数据源为上游代理出口。
* **IP质量检测**: `IP质量：<score>分（<verdict>），详情`。

#### c) 分流出站 (Sub-section)
* **混合身份**: `白名单VPS直连 + 其它代理`
* **白名单**: 列表显示域名或网段。默认显示前3条，超出部分折叠，提供“查看全部”的交互。
* **备注**: 卡片底部包含注释：`注：HY2/TUIC 为 UDP 通道，VPS 直连，不走代理分流`。

### 3.6 IP 质量检测实现规范 (方案A：静态渲染)
此功能旨在帮助用户快速判断出口IP的质量，以便更好地选择线路和分流策略。

#### a) Rationale (为什么值得加)
* **直观判断**: 一眼判断“这条出口”是否容易被网站识别或限流。
* **策略指导**: 对比 **VPS出站IP** 与 **代理出站IP** 的分数，能直观指导“白名单直连/走代理”的划分。
* **透明可信**: 方案配套“细项可解释 + 可重测 + 有时间戳”的设计，避免“分数”成为一个黑箱结论。

#### b) 前端实现与文件约定
* **显示**: 在“VPS出站IP”和“代理出站IP”两卡片中各增加一行占位符。
* **数据源**: 前端通过 `fetch` 直接读取由后端每日生成的静态 `.txt` 和 `.json` 文件。
    * `/var/www/edgebox/status/ipq_vps.json` / `.txt`
    * `/var/www/edgebox/status/ipq_proxy.json` / `.txt`
* **交互**: 点击“详情”时，使用 JavaScript 读取对应的 `.json` 文件内容，并渲染到一个弹窗 (`<dialog>`)中。
* **示例代码**:
    ```html
    <div>IP质量：<span id="ipq-vps-text">—</span>，<a href="#" id="ipq-vps-detail">详情</a></div>
    <div>IP质量：<span id="ipq-proxy-text">—</span>，<a href="#" id="ipq-proxy-detail">详情</a></div>

    <dialog id="ipq-dialog">
      </dialog>

    <script>
    // 最终版中提供的JS代码，用于实现静态文件读取和弹窗渲染
    </script>
    ```

#### c) 后端实现与自动化
* **核心脚本**: `/usr/local/bin/edgebox-ipq.sh` 负责执行所有检测和评分逻辑。
* **定时任务 (Cron)**: 每日凌晨（例如 02:15）自动执行一次评分脚本，覆盖生成最新的静态文件。
    ```bash
    15 2 * * * /usr/local/bin/edgebox-ipq.sh --out /var/www/edgebox/status --proxy '<proxy_url>' --targets vps,proxy
    ```

## 4. 后端 API 接口字段 (Data Contract)
主 `dashboard.json` 文件不再包含 `ipQuality` 字段。该数据已解耦，由前端按需从 `/var/www/edgebox/status/` 目录下的静态 `ipq_*.json` 文件中获取。主接口格式维持不变。
````

-----
