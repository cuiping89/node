# EdgeBox 安全增强功能架构设计

> **版本**: v1.0
> **文档用途**: 阐述 EdgeBox 核心安全功能（密钥轮换、SNI管理、流量随机化）的技术实现原理、设计决策与开发规范。

---

## **1. 改进概述**

### **1.1 安全理论基础**

EdgeBox 的安全改进遵循以下核心原则：
-   **加密正确性**：确保密码学实现无误。
-   **流量形态优化**：降低被 DPI/指纹识别的概率。
-   **端点信誉保护**：避免 IP/域名因特征固化而被标记。
-   **运维自动化**：通过自动化任务减少人工干预，提升安全性与健壮性。

### **1.2 核心功能模块**

| 优先级 | 项目名称 | 安全价值 | 实施复杂度 |
| :--- | :--- | :--- | :--- |
| 🔥 最高 | Reality 密钥轮换 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 🔥 最高 | SNI 域名池管理 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 🚀 高 | 流量特征随机化 | ⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## **2. Reality 密钥轮换系统**

### **2.1 设计目标**

-   **定期轮换**: 自动定期更换 Reality 协议的公私钥对，避免长期使用固定密钥带来的安全风险。
-   **自动化管理**: 通过 `systemd-run` 或 `cron` 实现无人值守的周期性任务。
-   **无缝切换**: `rotate-sid` 命令通过追加新 `shortId` 并设置延时清理任务的方式，为客户端提供平滑过渡期。

### **2.2 技术实现**

-   **密钥生成**: 直接调用 `sing-box generate reality-keypair` 命令生成新的密钥对。
-   **配置更新**:
    1.  **`rotate-reality`**: 使用 `jq` 同时更新 `server.json` (更新公钥、私钥、shortId) 和 `xray.json` (仅更新私钥和 shortId)。
    2.  **`rotate-sid`**: 使用 `jq` 向 `xray.json` 的 `shortIds` 数组中追加新的 `shortId`，并安排一个延时任务在宽限期结束后移除旧的 `shortId`。
-   **状态管理**: 在 `/etc/edgebox/config/reality-rotation.json` 文件中记录上次轮换时间、下次计划时间以及当前公钥，作为 `check_reality_rotation_needed` 函数的判断依据。
-   **服务重载**: 更新配置后，执行 `systemctl reload xray` 或 `restart` 使新密钥生效。
-   **订阅刷新**: 轮换后，立即调用 `regen_sub_ip` 或 `regen_sub_domain` 刷新订阅文件，确保用户能获取到包含新公钥和 `shortId` 的配置。

---

## **3. SNI 域名池智能管理**

### **3.1 设计目标**

-   **动态 SNI**: 避免 Reality 协议长期伪装成同一个目标站点。
-   **智能评分**: 基于可达性、响应时间、证书有效性等维度对备选域名进行评分，选择最优者。
-   **自动轮换**: 通过定时任务定期执行智能选择和切换。

### **3.2 技术实现**

-   **域名池配置**: 备选域名硬编码在 `install.sh` 的 `SNI_DOMAIN_POOL` 数组中，并在安装时写入 `/etc/edgebox/config/sni/domains.json`。
-   **评分算法 (`evaluate_sni_domain`)**:
    1.  **可达性**: 使用 `curl` 测试 HTTPS 可访问性 (40分)。
    2.  **响应时间**: 使用 `curl` 获取 `time_total`，根据耗时分档计分 (10-30分)。
    3.  **SSL 证书验证**: 使用 `openssl s_client` 验证证书链 (20分)。
    4.  **类别加分**: 对 `microsoft.com`, `apple.com` 等顶级域名给予额外加分 (10分)。
-   **配置更新 (`update_sni_domain`)**:
    1.  **无缝切换**: 使用 `jq` 向 `xray.json` 的 `serverNames` 数组中同时加入新旧两个域名。
    2.  **延时清理**: 安排一个 `systemd-run` 延时任务，在宽限期（如24小时）后，从配置中移除旧的 SNI 域名。
    3.  **多文件同步**: 同时更新 `xray.json` (后端服务) 和 `server.json` (前端数据源)，并刷新订阅文件，确保数据一致性。

---

## **4. 流量特征随机化**

### **4.1 设计目标**

-   **降低指纹特征**: 通过定期改变协议的非关键参数，使流量模式多样化，对抗基于固定特征的检测。
-   **分级策略**: 提供 `light`, `medium`, `heavy` 三种不同深度和频率的随机化策略，以平衡隐蔽性和稳定性。
-   **自动化调度**: 通过 `cron` 任务实现不同级别策略的自动化执行。

### **4.2 技术实现**

-   **参数定义**: 可随机化的参数（如 Hysteria2 的伪装站点）被定义在 `edgebox-traffic-randomize.sh` 脚本内部的数组中。
-   **随机化函数**:
    -   `randomize_hysteria2_config`: 从预设的 URL 列表中随机选择一个，并使用 `jq` 更新 `sing-box.json` 中的 `masquerade` 字段。
    -   `randomize_tuic_config`: 确保 `congestion_control` 设置为 `bbr`。
-   **安全机制**:
    -   **备份**: 在修改配置前，自动备份当前的 `xray.json` 和 `sing-box.json`。
    -   **验证**: 修改后，调用 `sing-box check` 或 `xray -test` 验证新配置的语法正确性。
    -   **回滚**: 如果验证失败，脚本会自动从备份中恢复上一版配置。
-   **调度执行**: 在主安装脚本中，通过 `setup_cron_jobs` 函数将不同级别的随机化命令写入 `crontab`，实现每日、每周、每月的自动执行。
