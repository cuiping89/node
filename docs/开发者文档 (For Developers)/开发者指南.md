
# **EdgeBox 开发者指南 (v3.0)**

本文档旨在为 EdgeBox 项目的开发者提供清晰的架构概览、模块化说明和开发规范，以确保项目的可维护性、稳定性和可扩展性。

## **1. 核心设计理念：模块化与内核契约**

EdgeBox 的核心设计是将复杂的部署和运维过程分解为多个独立的逻辑模块。这些模块在 `install.sh` 脚本中顺序执行，每个模块都基于前一个模块定义的\*\*“内核契约” (Kernel Contract)\*\* 进行开发。

**内核契约**是指模块之间关于文件路径、端口分配、服务依赖和配置格式的约定。遵循这些契约是保证系统稳定运行的基础。

-----

## **2. 内核契约 (Kernel Contract)**

所有开发活动都必须严格遵守以下核心约定：

| 契约类别 | 规范内容 |
| :--- | :--- |
| **文件路径** | - **主目录**: `/etc/edgebox` <br> - **配置**: `/etc/edgebox/config` <br> - **证书**: `/etc/edgebox/cert` <br> - **脚本**: `/etc/edgebox/scripts` <br> - **Web 根目录**: `/etc/edgebox/traffic` |
| **端口契约** | - **公网入口**: **TCP/443** 由 Nginx 独占监听，作为所有 TCP 协议的唯一入口。 <br> - **UDP 入口**: **UDP/443** (Hysteria2) 和 **UDP/2053** (TUIC) 由 sing-box 直接监听。 <br> - **内部回环**: Xray 的所有服务 (Reality, gRPC, WS, Trojan) 均监听 `127.0.0.1` 上的内部端口 (`11443`, `10085`, `10086`, `10143`)，不直接暴露。 |
| **分流机制** | - **Nginx-First**: Nginx 是唯一的流量分发中枢。它使用 `stream` 模块的 `ssl_preread` 功能，根据流量的 **SNI** 和 **ALPN**，将流量**直接转发 (proxy\_pass)** 到 Xray 对应的内部回环端口。**EdgeBox 不依赖 Xray 的回落 (fallbacks) 功能**。 |
| **证书契约** | - **统一软链接**: 所有服务 (Nginx, Xray, sing-box) 都必须从 `/etc/edgebox/cert/current.pem` 和 `current.key` 这两个软链接读取证书文件。模式切换通过更新软链接指向来实现。 |
| **订阅契约** | - **单一事实源**: `/etc/edgebox/config/subscription.txt` 是所有订阅内容的唯一来源。`edgeboxctl` 负责根据当前模式动态生成此文件。 |
| **数据契约** | - **核心数据**: `/etc/edgebox/config/server.json` 存储所有凭据、服务器信息等核心数据。 <br> - **面板数据**: `/etc/edgebox/traffic/dashboard.json` 是前端面板渲染所需的唯一聚合数据源。 |

-----

## **3. 脚本模块化详解 (`install.sh`)**

`install.sh` 脚本严格遵循模块化设计，分为七个主要部分：

### **模块 1: 基础环境与核心函数**

  - **职责**: 准备一个稳定、可靠的运行环境。
  - **核心任务**:
      - 自动提权到 `root`。
      - 定义全局变量、路径常量和日志函数。
      - 检查系统兼容性 (Ubuntu/Debian/CentOS)。
      - 安装所有系统级依赖包 (`nginx`, `certbot`, `jq`, `nftables` 等)。
      - 创建项目目录结构并设置权限。
      - 配置防火墙规则并优化系统参数 (BBR, 文件描述符等)。

### **模块 2: 系统信息与凭据生成**

  - **职责**: 收集服务器信息并生成所有必要的安全凭据。
  - **核心任务**:
      - 自动检测云厂商、硬件规格等信息。
      - 为所有协议 (`VLESS`, `Trojan`, `Hysteria2`, `TUIC`) 生成独立的 UUID 和强密码。
      - 调用 `sing-box` 生成 Reality 密钥对。
      - 生成自签名证书作为 IP 模式的默认证书。
      - 将所有收集和生成的信息统一写入 `server.json`。

### **模块 3: 核心服务安装与配置**

  - **职责**: 部署并配置 Nginx, Xray, sing-box 三大核心服务。
  - **核心任务**:
      - 下载并安装最新稳定版的 Xray 和 sing-box。
      - 生成 Nginx 主配置文件 (`nginx.conf`)，实现基于 SNI 和 ALPN 的 TCP 流量分发。
      - 生成 `xray.json`，配置 VLESS (Reality/gRPC/WS) 和 Trojan 监听内部回环端口。
      - 生成 `sing-box.json`，配置 Hysteria2 和 TUIC 监听公网 UDP 端口。
      - 创建并启用对应的 `systemd` 服务单元文件。

### **模块 4: Dashboard 后端与数据聚合**

  - **职责**: 创建为前端控制面板提供数据的后台脚本。
  - **核心任务**:
      - 生成 `dashboard-backend.sh` 脚本，负责定时聚合系统信息、服务状态、配置详情等，并输出为 `dashboard.json`。

### **模块 5: 运维工具与监控系统**

  - **职责**: 构建强大的运维能力。
  - **核心任务**:
      - **流量监控**: 创建 `traffic-collector.sh` 脚本，使用 `vnStat` 和 `nftables` 采集流量数据，并生成 `traffic.json`。
      - **管理工具**: 创建核心管理工具 `edgeboxctl`，集成所有运维命令。
      - **IP 质量评分**: 创建 `edgebox-ipq.sh` 脚本，用于评估出口 IP 质量。
      - **流量预警**: 创建 `traffic-alert.sh` 脚本，用于实现流量告警。

### **模块 6: 数据初始化与主流程控制**

  - **职责**: 编排整个安装流程，并完成数据的最终生成和同步。
  - **核心任务**:
      - 执行预安装检查。
      - 按顺序调用模块 1-5 的核心函数。
      - 首次生成所有数据文件 (`dashboard.json`, `traffic.json` 等)。
      - 启动并验证所有服务。
      - 在安装结束时，显示包含访问信息和常用命令的成功摘要。

### **模块 7: 前端控制面板**

  - **职责**: 提供一个用户友好的 Web UI。
  - **核心任务**:
      - 生成静态的 `index.html`, `edgebox-panel.css`, `edgebox-panel.js` 文件。
      - 前端通过 `fetch` API 异步加载 `dashboard.json`, `traffic.json`, `system.json` 等数据文件来动态渲染页面。

-----

## **4. 开发与贡献流程**

1.  **理解内核契约**: 在进行任何修改前，请务必完全理解第二节定义的内核契约，确保您的改动不会破坏模块间的依赖关系。
2.  **模块化修改**: 尽量将您的修改限制在对应的模块内。例如，若要调整 Nginx 分流逻辑，应在**模块 3** 的 `configure_nginx` 函数中进行。
3.  **`edgeboxctl` 优先**: 对于用户可配置的功能，应优先通过扩展 `edgeboxctl` 命令来实现，而不是直接修改核心配置文件。
4.  **数据驱动**: 前端 UI 的任何变更，都应通过修改 `dashboard-backend.sh` 来调整 `dashboard.json` 的数据结构，前端只负责渲染。
5.  **测试**:
      - **功能测试**: 在干净的虚拟机上完整运行 `install.sh`，验证您的功能是否按预期工作。
      - **幂等性测试**: 多次运行安装脚本，确保不会产生重复配置或错误。
      - **卸载测试**: 运行 `uninstall.sh`，确保您的改动能被完全清理。
