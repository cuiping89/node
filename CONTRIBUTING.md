
### **分模块开发**

该项目的设计理念是将复杂的部署和运维过程分解为三个独立的模块，每个模块都基于前一个模块定义的**“内核契约”**进行开发。这种分层架构确保了项目的可维护性、稳定性和可扩展性。

### 模块 1 - 核心基础安装（内核契约）

**目标**：提供一个功能完整、稳定可靠的基础安装包。该模块负责所有核心服务的部署，并定义后续模块将依赖的**“内核契约”**。

**协议配置与契约定义**
* **端口契约**：公网 **443/TCP 端口**由 **Nginx 监听**，作为所有 TCP 协议的唯一入口。Xray 的 Reality、VLESS-gRPC 和 VLESS-WS 服务均监听**内部回环端口**，不直接暴露在公网。VLESS-Reality 监听 `127.0.0.1:11443`；VLESS-gRPC 监听 `127.0.0.1:10085`；VLESS-WS 监听 `127.0.0.1:10086`。
* **分流机制**：**Nginx** 负责唯一的流量分发。它使用 `stream` 模块的 `ssl_preread` 功能，根据流量的 **SNI** 和 **ALPN**，直接将流量转发到 Xray 对应的内部回环端口。本方案不依赖 Xray 的任何回落（fallbacks）功能。
* **证书软链接**：确保所有服务（Nginx, Xray, sing-box）都从 `CERT_DIR/current.pem` 和 `CERT_DIR/current.key` 获取证书。这是模块 2 动态证书管理的基础。
* **基础订阅**：确保 `install.sh` 在安装完成后能生成一个基础的、硬编码的订阅链接。订阅链接的格式、字段是模块 2 动态生成订阅的契约。

**测试与验证**
* **功能测试**：在干净的虚拟机上运行 `install.sh`，验证所有服务是否正常运行、端口是否正确监听，以及客户端是否能成功连接所有 5 个协议。
* **幂等卸载测试**：运行 `uninstall.sh` 并验证所有文件和服务是否被完全清除。

---

### 模块 2 - `edgeboxctl` 管理工具

**前置条件**：模块 1 已完成并冻结“内核契约”。模块 2 的开发必须基于这些已定义的端口、文件路径和订阅格式。
**目标**：开发一个命令行工具，作为用户与核心服务进行交互的管理层，实现动态配置和模式切换。

**关键任务与交付物**
* **命令行工具 (`edgeboxctl`)**：使用 Shell 脚本（或 Python/Go）开发。
* **模式切换**：实现 `edgeboxctl config switch-mode` 命令，用于在 IP 模式和域名模式之间双向切换。
* **证书管理**：`edgeboxctl cert renew` 和 `edgeboxctl cert upload`。
* **配置管理**：`edgeboxctl config regenerate-uuid` 和 `edgeboxctl config show`。
* **动态订阅生成**：`edgeboxctl sub` 命令应根据当前模式（IP/域名）和配置，动态生成并显示订阅链接。

---

### 模块 3 - 高级运维功能（可选）

**前置条件**：模块 1 和 2 已完成，并已建立稳定的内核和管理层。该模块将利用 `edgeboxctl` 工具提供的接口，实现自动化和高级运维功能，不影响核心服务的稳定性。

* **出站分流**
    * **流量路由**：在 sing-box 的配置中添加出站规则，通过识别特定域名（如 `googlevideo.com`）将其流量直连，而将剩余的流量通过代理（如住宅代理）出站。
    * **配置管理**：`edgeboxctl shunt` 命令集提供了完整的出站分流管理。它支持三种模式（`vps`、`resi`、`direct_resi`）的切换，以及白名单维护，并能在代理不可用时自动回退到 `vps` 模式。

* **流量统计**
    * **数据收集**：使用 `vnStat` 或 `iptables` 作为流量数据收集器。
    * **命令行接口**：`edgeboxctl traffic` 命令集用于显示和重置流量。它将数据与订阅链接集成到一个浏览器页面中，通过 Nginx 托管在站点根路径 `http://<your-ip-or-domain>/`。

* **自动备份与恢复**
    * **备份脚本**：创建脚本，每日自动备份 `/etc/edgebox/`、核心配置以及 `vnStat` 的数据文件到 `/root/edgebox-backup/` 目录。
    * **定时任务**：配置 `cron` 任务，每日自动运行备份脚本，并保留最近 N 个备份版本。
    * **恢复命令**：`edgeboxctl backup restore <timestamp>` 命令可以解压指定时间戳的备份文件，覆盖现有配置并重新加载服务。
 

